<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="MBRjun-Blog"><title>针对 LUKS 自动解锁的冷启动攻击 - MBRjun-Blog</title><meta name="author" content="MBRjun"><meta name="keywords" content="MBRjun,Linux,服务器,软路由,PVE,原神,maimai,JavaScript,Windows,Microsoft,git,Node.JS,"><link rel="icon" href="https://cos.mbrjun.cn/PICS/LG4v3avatar144px.jpg"><link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml"><script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"MBRjun","sameAs":["https://github.com/MBRjun","https://twitter.com/MBRjun","mailto:neko@mbr.moe"],"image":"https://cos.mbrjun.cn/PICS/LG4v3avatar144px.jpg"},"articleBody":"对于系统卷全盘加密（FDE），任何不将分区解锁密钥存储在硬件安全设备（如 TPM）的自动解锁方法都不应认为是安全的  \n即使使用硬件安全设备，仍需要额外保护（如 TPM PIN）和内存加密才能保证基本安全  \n\n\n笔者之前见过一个 Linux 发行版，为了限制用户权限，系统安装时会自动将分区加密，防止用户修改系统文件，此加密使用 LUKS，解锁密钥在 grub-install 的过程中写入磁盘，开机时使用磁盘中的密钥自动解锁，如前面两段话所说，这种加密方法并不安全，“防君子不防小人”，可以直接从内存中提取密钥（因为开机后，系统若要正常运行，必须将 AES 密钥载入内存），这种从内存中提取密钥的破解方法被称为“冷启动攻击”  \n此文章仅展示 LUKS 自动解锁时可能存在的安全问题，其他磁盘加密机制如 BitLocker 也存在此问题，请不要将此教程用于违法用途  \n若要保证数据安全，请配置 TPM PIN 或其他预验证机制，并启用内存加密。这可以有效防止冷启动攻击  \n其中，内存加密可以防止攻击者读取你的内存获取明文密钥，预验证机制则在密钥写入内存前要求验证，防止攻击者将硬盘拆下，安装至其他计算机进行攻击  \n\n\n因为这种加密的自动解锁方式安全性几乎为 0，所以写一篇破解教程进行演示  \n什么是冷启动攻击？冷启动攻击（cold boot attack）是在攻击者使用冷启动重新启动计算机后，通过技术手段转储内存，从内存中提取密钥或其他敏感信息\n\n\n本教程演示的操作全部在本地搭建的 KVM 虚拟机完成，对于虚拟机来说，攻击成本极低，而对于实体机，攻击则需要准备液氮（用于冷却内存，防止数据快速丢失）和专用读取器  \n准备\nLinux 机器做为宿主机\n配置了 LUKS 的虚拟机，且开机时 grub 会在磁盘中读取密钥进行解密\n\n操作过程1 - 安装操作系统创建虚拟机并安装操作系统，这个操作就不讲了，本文直接使用上面提到的“为了限制用户权限”的发行版演示，敏感内容均已打码  \n\n2 - 分析分区结构操作系统安装完成后，使用工具 cfdisk 查看磁盘分区表： \n\n可以看到大致分区结构如下： \n\n前 32768 个扇区（16 MiB）保留\n一个 vfat EFI 分区，存储 Grub EFI 文件  \n一个 ext4 启动分区，存储 Grub 文件和操作系统内核  \n一个 LUKS 加密卷\n\n在未加密的启动分区可以找到 grub.cfg，打开后确认是开机时自动解密系统分区，且未直接将解锁密钥存储在配置文件中  \n\nGrub 在启动时已经自动解锁系统分区，启动系统过程中，Grub 会将加密系统卷的 UUID（红线）、加密系统卷的密钥路径（黄线）和内核所在分区的 UUID（绿线）传递给内核，以便在 initrd 中正常解锁  \n如果 Grub 没有配置密码，或者你可以更改 Grub 配置文件删除密码，你可以直接在 Grub Shell 中使用 cat 命令跟上密钥路径获取密钥  \n但如果 Grub 设置了密码，同时引导分区加密，将无法使用此方法，只能使用冷启动攻击。冷启动攻击是一种通用的攻击方法  \n\n\n3 - 转储内存使用正常方法开机（此步骤被称为冷启动，这也是冷启动攻击一词的由来）  \n等待操作系统完成磁盘解密后（出现登录屏幕），执行下面的操作：\n\n对于虚拟机：  在宿主机上，休眠该虚拟机，创建的休眠文件包含内存转储\n对于物理机：  使用液氮冷却剂为内存冷却，将内存拆下并安装到硬件转储器，创建内存转储\n\n建议使用允许系统正常启动的最小内存，大多数情况 4 GiB 是足够的，大内存可能会导致转储文件很大  \n正常情况下，转储文件的大小最大为内存大小的 3 倍，请保留充足的磁盘空间\n\n\nProxmox VE 默认配置中创建的休眠文件是一个 LVM 卷，如下：\n1234Disk /dev/mapper/pve-vm--299--state--suspend--2024--03--31: 8.49 GiB, 9114222592 bytes, 17801216 sectorsUnits: sectors of 1 * 512 = 512 bytesSector size (logical/physical): 512 bytes / 512 bytesI/O size (minimum/optimal): 65536 bytes / 65536 bytes\n\n我们可以使用命令将 LVM 卷转换为文件：\n1dd if=/dev/mapper/pve-vm--299--state--suspend--2024--03--31 of=MEMORY.dmp\n\n4 - 提取 AES 密钥安装 findaes 工具，然后使用下面的命令提取转储文件中的 AES 密钥：  \n1findaes MEMORY.dmp\n\n输出类似：\n123456789Searching MEMORY.dmpFound AES-128 key schedule at offset 0x1bab8a9:85 f1 dd c6 ea 68 09 6c d9 8d e8 39 65 8c 61 70Found AES-128 key schedule at offset 0x1baba99:a3 9e cb 7d 01 b3 fb 9e 4e 1a e0 a4 ec a3 7e a8Found AES-128 key schedule at offset 0x129589f8:b7 40 59 a2 0c c0 2e a3 0c 89 71 a3 16 ff 20 66Found AES-256 key schedule at offset 0x1b564786:ae 66 77 dd e6 e6 10 3c b5 f6 a2 a0 56 1a b1 df 41 f0 ce c3 d7 5b 4c ef c3 4a eb a7 e6 e8 2d 1e\n\n如果有两个连续的 AES-128 密钥，请拼接为 AES-256 密钥（地址靠后的 + 地址靠前的），例如上面输出中 0x1baba99 和 0x1bab8a9 地址连续，拼接为 a3 9e cb 7d 01 b3 fb 9e 4e 1a e0 a4 ec a3 7e a8 85 f1 dd c6 ea 68 09 6c d9 8d e8 39 65 8c 61 70同样的，如果有四个连续的 AES-128 或两个连续的 AES-256，则拼接为 AES-512  \n然后将所有提取到的密钥整理一下，去掉空格，从上面的输出我们就得到了这三个密钥：\n\nAES-128 b74059a20cc02ea30c8971a316ff2066\nAES-256 a39ecb7d01b3fb9e4e1ae0a4eca37ea885f1ddc6ea68096cd98de839658c6170（由两个 AES-128 拼接）\nAES-256 ae6677dde6e6103cb5f6a2a0561ab1df41f0cec3d75b4cefc34aeba7e6e82d1e\n\n5 - 解密卷将密钥转换为二进制写入文件：\n1echo a39ecb7d01b3fb9e4e1ae0a4eca37ea885f1ddc6ea68096cd98de839658c6170 | xxd -r -p &gt; key.txt\n\n然后尝试使用 AES 密钥为加密卷添加密码：\n1cryptsetup luksAddKey /dev/vda3 --master-key-file key.txt\n\n如果提示 Enter new passphrase for key slot: ，则此 AES 密钥与分区解密密钥对应，继续设置密码即可  \n如果密钥错误，则提示 Volume key does not match the volume. ，此时需要继续尝试其他密钥，直到解密成功  \n如果有多个分区，则为每个分区尝试上面的步骤  \n6 - 挂载密码设置完成后，我们就可以直接使用密码解密 LUKS 卷并挂载，理论上此方法也完全适用于 BitLocker，但是笔者并未进行测试  \n做好了对冷启动攻击的防护也不能保证数据绝对安全，因为除了冷启动攻击，针对磁盘加密还有许多其他类型攻击，比如 DMA 攻击，通常是将计算机的网卡或其他硬件更换为特殊读取器进行攻击，部分操作系统现在已经默认开启 DMA 攻击的内核防护  \n\n","dateCreated":"2024-03-31T08:00:00+08:00","dateModified":"2024-03-31T08:00:00+08:00","datePublished":"2024-03-31T08:00:00+08:00","description":"对于系统卷全盘加密（FDE），任何不将分区解锁密钥存储在硬件安全设备（如 TPM）的自动解锁方法都不应认为是安全的  \n即使使用硬件安全设备，仍需要额外保护（如 TPM PIN）和内存加密才能保证基本安全  ","headline":"针对 LUKS 自动解锁的冷启动攻击","image":["https://cos.mbrjun.cn/IMGS/2024/03/31/8faba14b-a7a4-4a1e-8a23-037d97e48732.webp"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.mbrjun.cn/archives/496/"},"publisher":{"@type":"Organization","name":"MBRjun","sameAs":["https://github.com/MBRjun","https://twitter.com/MBRjun","mailto:neko@mbr.moe"],"image":"https://cos.mbrjun.cn/PICS/LG4v3avatar144px.jpg","logo":{"@type":"ImageObject","url":"https://cos.mbrjun.cn/PICS/LG4v3avatar144px.jpg"}},"url":"https://www.mbrjun.cn/archives/496/","keywords":"LUKS, BitLocker, 冷启动攻击","thumbnailUrl":"https://cos.mbrjun.cn/IMGS/2024/03/31/8faba14b-a7a4-4a1e-8a23-037d97e48732.webp"}</script><meta name="description" content="对于系统卷全盘加密（FDE），任何不将分区解锁密钥存储在硬件安全设备（如 TPM）的自动解锁方法都不应认为是安全的   即使使用硬件安全设备，仍需要额外保护（如 TPM PIN）和内存加密才能保证基本安全"><meta property="og:type" content="blog"><meta property="og:title" content="针对 LUKS 自动解锁的冷启动攻击"><meta property="og:url" content="https://www.mbrjun.cn/archives/496/index.html"><meta property="og:site_name" content="MBRjun-Blog"><meta property="og:description" content="对于系统卷全盘加密（FDE），任何不将分区解锁密钥存储在硬件安全设备（如 TPM）的自动解锁方法都不应认为是安全的   即使使用硬件安全设备，仍需要额外保护（如 TPM PIN）和内存加密才能保证基本安全"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cos.mbrjun.cn/IMGS/2024/03/31/93aa31a6-4e26-41a5-b88e-a90f80eddd2d.webp"><meta property="og:image" content="https://cos.mbrjun.cn/IMGS/2024/03/31/e7946926-8cf1-41b2-bcc9-87f5bb279f0c.webp"><meta property="og:image" content="https://cos.mbrjun.cn/IMGS/2024/03/31/8140fc65-8719-4533-b2e9-ae793ab10c3a.webp"><meta property="article:published_time" content="2024-03-31T00:00:00.000Z"><meta property="article:modified_time" content="2024-03-31T00:00:00.000Z"><meta property="article:author" content="MBRjun"><meta property="article:tag" content="LUKS"><meta property="article:tag" content="BitLocker"><meta property="article:tag" content="冷启动攻击"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cos.mbrjun.cn/IMGS/2024/03/31/93aa31a6-4e26-41a5-b88e-a90f80eddd2d.webp"><meta name="twitter:creator" content="@MBRjun"><meta property="og:image" content="https://cos.mbrjun.cn/PICS/LG4v3avatar144px.jpg"><meta property="og:image" content="https://cos.mbrjun.cn/IMGS/2024/03/31/8faba14b-a7a4-4a1e-8a23-037d97e48732.webp"><meta class="swiftype" name="image" data-type="enum" content="https://cos.mbrjun.cn/IMGS/2024/03/31/8faba14b-a7a4-4a1e-8a23-037d97e48732.webp"><!--STYLES--><link rel="stylesheet" href="/assets/css/style.min.css?v=972fa94119cd818bad8e98d0faf8a93bc7603c31"><!--STYLES END--><!--SCRIPTS--><script async="" defer="" src="/assets/js/script.min.js?v=972fa94119cd818bad8e98d0faf8a93bc7603c31"></script><!--SCRIPTS END--><!--PRELOAD--><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="//github.githubassets.com"><link rel="dns-prefetch" href="//avatars.githubusercontent.com"><link rel="preconnect" href="https://cos.mbrjun.cn"><link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="/assets/fonts/GoogleSansDisplay-BR.woff2"><link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="/assets/fonts/GoogleSansDisplay-LR.woff2"><link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="/assets/fonts/fa-solid-900.woff2"><link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="/assets/fonts/fa-brands-400.woff2"><!--PRELOAD END--><script>"use strict";var scripts=["/assets/js/webp-polyfill.min.js?v=2.0.1"];function parallelLoadScripts(e,t){"object"!=typeof e&&(e=[e]);for(var n=document.getElementsByTagName("head")[0]||document.documentElement,o=[],l=0,i=0;i<e.length;i++)o[i]=document.createElement("script"),o[i].setAttribute("type","text/javascript"),o[i].onload=o[i].onreadystatechange=function(){l++,this.onload=this.onreadystatechange=null,this.parentNode.removeChild(this),l===e.length&&"function"==typeof t&&t()},o[i].setAttribute("src",e[i]),n.appendChild(o[i])}"ActiveXObject"in window&&parallelLoadScripts(scripts,function(){console.log("[hexo-webp-polyfill] polyfilling document"),(new webpHero.WebpMachine).polyfillDocument()});</script></head><body><div id="blog"><!-- Define author's picture --><header id="header" data-behavior="2"><i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i><div class="header-title"><a class="header-title-link" href="/" aria-label="">MBRjun-Blog</a></div><a class="header-right-picture" href="/about" aria-label="打开链接: /about"><img class="header-picture" src="https://cos.mbrjun.cn/PICS/LG4v3avatar144px.jpg" alt="作者的图片"></a></header><!-- Define author's picture --><nav id="sidebar" data-behavior="2"><div class="sidebar-container"><div class="sidebar-profile"><a href="/#about" aria-label="阅读有关作者的更多信息"><img class="sidebar-profile-picture" src="https://cos.mbrjun.cn/PICS/LG4v3avatar144px.jpg" alt="作者的图片"></a><h4 class="sidebar-profile-name">MBRjun</h4><h5 class="sidebar-profile-bio"><p>我们生活在大地上，但我们的梦想超越天空</p></h5></div><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/" rel="noopener" title="首页"><i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i> <span class="sidebar-button-desc">首页</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-categories" rel="noopener" title="分类"><i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i> <span class="sidebar-button-desc">分类</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-tags" rel="noopener" title="标签"><i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i> <span class="sidebar-button-desc">标签</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-archives" rel="noopener" title="归档"><i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i> <span class="sidebar-button-desc">归档</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/links" rel="noopener" title="友情链接"><i class="sidebar-button-icon fa fa-link" aria-hidden="true"></i> <span class="sidebar-button-desc">友情链接</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="https://www.travellings.cn/go.html" target="_blank" rel="noopener" title="开往"><i class="sidebar-button-icon fa fa-paper-plane" aria-hidden="true"></i> <span class="sidebar-button-desc">开往</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="https://github.com/MBRjun" target="_blank" rel="noopener" title="GitHub"><i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i> <span class="sidebar-button-desc">GitHub</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="https://twitter.com/MBRjun" target="_blank" rel="noopener" title="Twitter"><i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i> <span class="sidebar-button-desc">Twitter</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="mailto:neko@mbr.moe" target="_blank" rel="noopener" title="邮箱"><i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i> <span class="sidebar-button-desc">邮箱</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/atom.xml" rel="noopener" title="RSS"><i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i> <span class="sidebar-button-desc">RSS</span></a></li></ul></div></nav><div id="main" data-behavior="2" class="hasCoverMetaIn"><article class="post"><div class="post-header main-content-wrap text-left"><h1 class="post-title">针对 LUKS 自动解锁的冷启动攻击</h1><div class="post-meta"><time datetime="2024-03-31T08:00:00+08:00">2024 年 3 月 31 日 </time><span>发布在 </span><a class="category-link" href="/categories/%E5%AE%89%E5%85%A8/">安全</a></div></div><div class="post-content markdown"><div class="main-content-wrap"><p>对于系统卷全盘加密（FDE），任何不将分区解锁密钥存储在硬件安全设备（如 TPM）的自动解锁方法都不应认为是安全的</p><p>即使使用硬件安全设备，仍需要额外保护（如 TPM PIN）和内存加密才能保证基本安全</p><span id="more"></span><p>笔者之前见过一个 Linux 发行版，为了限制用户权限，系统安装时会自动将分区加密，防止用户修改系统文件，此加密使用 LUKS，解锁密钥在 <code>grub-install</code> 的过程中写入磁盘，开机时使用磁盘中的密钥自动解锁，如前面两段话所说，这种加密方法并不安全，“防君子不防小人”，可以直接从内存中提取密钥（因为开机后，系统若要正常运行，必须将 AES 密钥载入内存），这种从内存中提取密钥的破解方法被称为“冷启动攻击”</p><div class="alert warning"><p>此文章仅展示 LUKS 自动解锁时可能存在的安全问题，其他磁盘加密机制如 BitLocker 也存在此问题，<strong>请不要将此教程用于违法用途</strong></p><p>若要保证数据安全，请配置 TPM PIN 或其他预验证机制，并启用内存加密。这可以有效防止冷启动攻击</p><p>其中，内存加密可以防止攻击者读取你的内存获取明文密钥，预验证机制则在密钥写入内存前要求验证，防止攻击者将硬盘拆下，安装至其他计算机进行攻击</p></div><p>因为这种加密的自动解锁方式安全性几乎为 0，所以写一篇破解教程进行演示</p><div class="alert info"><p><strong>什么是冷启动攻击？</strong><br>冷启动攻击（cold boot attack）是在攻击者使用冷启动重新启动计算机后，通过技术手段转储内存，从内存中提取密钥或其他敏感信息</p></div><p>本教程演示的操作全部在本地搭建的 KVM 虚拟机完成，对于虚拟机来说，攻击成本极低，而对于实体机，攻击则需要准备液氮（用于冷却内存，防止数据快速丢失）和专用读取器</p><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ul><li>Linux 机器做为宿主机</li><li>配置了 LUKS 的虚拟机，且开机时 grub 会在磁盘中读取密钥进行解密</li></ul><h2 id="操作过程"><a href="#操作过程" class="headerlink" title="操作过程"></a>操作过程</h2><h3 id="1-安装操作系统"><a href="#1-安装操作系统" class="headerlink" title="1 - 安装操作系统"></a>1 - 安装操作系统</h3><p>创建虚拟机并安装操作系统，这个操作就不讲了，本文直接使用上面提到的“为了限制用户权限”的发行版演示，敏感内容均已打码</p><p><img src="https://cos.mbrjun.cn/IMGS/2024/03/31/93aa31a6-4e26-41a5-b88e-a90f80eddd2d.webp" alt="Proxmox VE create VM"></p><h3 id="2-分析分区结构"><a href="#2-分析分区结构" class="headerlink" title="2 - 分析分区结构"></a>2 - 分析分区结构</h3><p>操作系统安装完成后，使用工具 cfdisk 查看磁盘分区表：</p><p><img src="https://cos.mbrjun.cn/IMGS/2024/03/31/e7946926-8cf1-41b2-bcc9-87f5bb279f0c.webp" alt="cfdisk"></p><p>可以看到大致分区结构如下：</p><ul><li>前 32768 个扇区（16 MiB）保留</li><li>一个 vfat EFI 分区，存储 Grub EFI 文件</li><li>一个 ext4 启动分区，存储 Grub 文件和操作系统内核</li><li>一个 LUKS 加密卷</li></ul><p>在未加密的启动分区可以找到 <code>grub.cfg</code>，打开后确认是开机时自动解密系统分区，且未直接将解锁密钥存储在配置文件中</p><p><img src="https://cos.mbrjun.cn/IMGS/2024/03/31/8140fc65-8719-4533-b2e9-ae793ab10c3a.webp" alt="Grub menuentry"></p><p>Grub 在启动时已经自动解锁系统分区，启动系统过程中，Grub 会将加密系统卷的 UUID（红线）、加密系统卷的密钥路径（黄线）和内核所在分区的 UUID（绿线）传递给内核，以便在 initrd 中正常解锁</p><div class="alert info"><p>如果 Grub 没有配置密码，或者你可以更改 Grub 配置文件删除密码，你可以直接在 Grub Shell 中使用 <code>cat</code> 命令跟上密钥路径获取密钥</p><p>但如果 Grub 设置了密码，同时引导分区加密，将无法使用此方法，只能使用冷启动攻击。冷启动攻击是一种通用的攻击方法</p></div><h3 id="3-转储内存"><a href="#3-转储内存" class="headerlink" title="3 - 转储内存"></a>3 - 转储内存</h3><p>使用正常方法开机（此步骤被称为冷启动，这也是冷启动攻击一词的由来）</p><p>等待操作系统完成磁盘解密后（出现登录屏幕），执行下面的操作：</p><ul><li><strong>对于虚拟机：</strong><br>在宿主机上，休眠该虚拟机，创建的休眠文件包含内存转储</li><li><strong>对于物理机：</strong><br>使用液氮冷却剂为内存冷却，将内存拆下并安装到硬件转储器，创建内存转储</li></ul><div class="alert info"><p>建议使用允许系统正常启动的最小内存，大多数情况 4 GiB 是足够的，大内存可能会导致转储文件很大</p><p>正常情况下，转储文件的大小最大为内存大小的 3 倍，请保留充足的磁盘空间</p></div><p>Proxmox VE 默认配置中创建的休眠文件是一个 LVM 卷，如下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Disk /dev/mapper/pve-vm--299--state--suspend--2024--03--31: 8.49 GiB, 9114222592 bytes, 17801216 sectors<br>Units: sectors of 1 * 512 = 512 bytes<br>Sector size (logical/physical): 512 bytes / 512 bytes<br>I/O size (minimum/optimal): 65536 bytes / 65536 bytes<br></code></pre></td></tr></tbody></table></figure><p>我们可以使用命令将 LVM 卷转换为文件：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/mapper/pve-vm--299--state--suspend--2024--03--31 of=MEMORY.dmp<br></code></pre></td></tr></tbody></table></figure><h3 id="4-提取-AES-密钥"><a href="#4-提取-AES-密钥" class="headerlink" title="4 - 提取 AES 密钥"></a>4 - 提取 AES 密钥</h3><p>安装 <code>findaes</code> 工具，然后使用下面的命令提取转储文件中的 AES 密钥：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">findaes MEMORY.dmp<br></code></pre></td></tr></tbody></table></figure><p>输出类似：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Searching MEMORY.dmp<br>Found AES-128 key schedule at offset 0x1bab8a9:<br>85 f1 dd c6 ea 68 09 6c d9 8d e8 39 65 8c 61 70<br>Found AES-128 key schedule at offset 0x1baba99:<br>a3 9e cb 7d 01 b3 fb 9e 4e 1a e0 a4 ec a3 7e a8<br>Found AES-128 key schedule at offset 0x129589f8:<br>b7 40 59 a2 0c c0 2e a3 0c 89 71 a3 16 ff 20 66<br>Found AES-256 key schedule at offset 0x1b564786:<br>ae 66 77 dd e6 e6 10 3c b5 f6 a2 a0 56 1a b1 df 41 f0 ce c3 d7 5b 4c ef c3 4a eb a7 e6 e8 2d 1e<br></code></pre></td></tr></tbody></table></figure><p>如果有两个连续的 AES-128 密钥，请拼接为 AES-256 密钥（地址靠后的 + 地址靠前的），例如上面输出中 <code>0x1baba99</code> 和 <code>0x1bab8a9</code> 地址连续，拼接为 <code>a3 9e cb 7d 01 b3 fb 9e 4e 1a e0 a4 ec a3 7e a8 85 f1 dd c6 ea 68 09 6c d9 8d e8 39 65 8c 61 70</code><br>同样的，如果有四个连续的 AES-128 或两个连续的 AES-256，则拼接为 AES-512</p><p>然后将所有提取到的密钥整理一下，去掉空格，从上面的输出我们就得到了这三个密钥：</p><ul><li>AES-128 <code>b74059a20cc02ea30c8971a316ff2066</code></li><li>AES-256 <code>a39ecb7d01b3fb9e4e1ae0a4eca37ea885f1ddc6ea68096cd98de839658c6170</code>（由两个 AES-128 拼接）</li><li>AES-256 <code>ae6677dde6e6103cb5f6a2a0561ab1df41f0cec3d75b4cefc34aeba7e6e82d1e</code></li></ul><h3 id="5-解密卷"><a href="#5-解密卷" class="headerlink" title="5 - 解密卷"></a>5 - 解密卷</h3><p>将密钥转换为二进制写入文件：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">echo</span> a39ecb7d01b3fb9e4e1ae0a4eca37ea885f1ddc6ea68096cd98de839658c6170 | xxd -r -p &gt; key.txt<br></code></pre></td></tr></tbody></table></figure><p>然后尝试使用 AES 密钥为加密卷添加密码：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">cryptsetup luksAddKey /dev/vda3 --master-key-file key.txt<br></code></pre></td></tr></tbody></table></figure><p>如果提示 <em>Enter new passphrase for key slot:</em> ，则此 AES 密钥与分区解密密钥对应，继续设置密码即可</p><p>如果密钥错误，则提示 <em>Volume key does not match the volume.</em> ，此时需要继续尝试其他密钥，直到解密成功</p><p>如果有多个分区，则为每个分区尝试上面的步骤</p><h3 id="6-挂载"><a href="#6-挂载" class="headerlink" title="6 - 挂载"></a>6 - 挂载</h3><p>密码设置完成后，我们就可以直接使用密码解密 LUKS 卷并挂载，理论上此方法也完全适用于 BitLocker，但是笔者并未进行测试</p><div class="alert info"><p>做好了对冷启动攻击的防护也不能保证数据绝对安全，因为除了冷启动攻击，针对磁盘加密还有许多其他类型攻击，比如 DMA 攻击，通常是将计算机的网卡或其他硬件更换为特殊读取器进行攻击，部分操作系统现在已经默认开启 DMA 攻击的内核防护</p></div></div></div><div id="post-footer" class="post-footer main-content-wrap"><div class="post-footer-tags"><span class="text-color-light text-small">标签</span><br><a class="tag tag--primary tag--small t-none-link" href="/tags/BitLocker/" rel="tag">BitLocker</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/LUKS/" rel="tag">LUKS</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/%E5%86%B7%E5%90%AF%E5%8A%A8%E6%94%BB%E5%87%BB/" rel="tag">冷启动攻击</a></div><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/archives/497/" data-tooltip="将 Debian 的根目录 FS 切换为 ZFS" aria-label="上一篇: 将 Debian 的根目录 FS 切换为 ZFS"><i class="fa fa-angle-left" aria-hidden="true"></i> <span class="hide-xs hide-sm text-small icon-ml">上一篇</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/archives/495/" data-tooltip="2024 来啦！" aria-label="下一篇: 2024 来啦！"><span class="hide-xs hide-sm text-small icon-mr">下一篇</span> <i class="fa fa-angle-right" aria-hidden="true"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Diesen Beitrag teilen"><i class="fa fa-share-alt" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://www.mbrjun.cn/archives/496/" title="分享到 Twitter" aria-label="分享到 Twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://www.mbrjun.cn/archives/496/" title="分享到 Weibo" aria-label="分享到 Weibo"><i class="fab fa-weibo" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://www.mbrjun.cn/archives/496/&amp;title=针对 LUKS 自动解锁的冷启动攻击" title="分享到 QQ" aria-label="分享到 QQ"><i class="fab fa-qq" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.mbrjun.cn/archives/496/" title="分享到 Qzone" aria-label="分享到 Qzone"><i class="fa fa-star" aria-hidden="true"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben"><i class="fa fa-list" aria-hidden="true"></i></a></li></ul></div><script src="https://giscus.mbrjun.cn/client.js" data-repo="MBRjun/MBRjun-Blog" data-repo-id="R_kgDOIbI33Q" data-category="Blog" data-category-id="DIC_kwDOIbI33c4CTUTq" data-mapping="title" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light_tritanopia" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async=""></script></div></article><footer id="footer" class="main-content-wrap"><span class="copyrights"><a target="_blank" rel="noopener" href="https://github.com/MBRjun/MBRjun-Blog">GitHub 源代码</a> - <a target="_blank" rel="noopener" href="https://github.com/MBRjun/MBRjun-Blog/blob/main/LICENSE">LICENSE(CC BY-SA 3)</a><br></span><span class="text-small"><a target="_blank" href="https://beian.miit.gov.cn" rel="nofollow noopener">闽ICP备2024060656号-1</a> - <a target="_blank" href="http://www.beian.gov.cn" rel="nofollow noopener">津公网安备12010102001086号</a><br></span><span class="copyrights">Copyrights © 2024 MBRjun. All Rights Reserved.</span></footer><script async="" defer="" data-website-id="d1e9e8b4-ed73-416a-b8e7-ae518e698da6" src="https://delightful.mbrjun.cn/delightful.js?v=2.2.0-1"></script></div><div id="bottom-bar" class="post-bottom-bar" data-behavior="2"><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/archives/497/" data-tooltip="将 Debian 的根目录 FS 切换为 ZFS" aria-label="上一篇: 将 Debian 的根目录 FS 切换为 ZFS"><i class="fa fa-angle-left" aria-hidden="true"></i> <span class="hide-xs hide-sm text-small icon-ml">上一篇</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/archives/495/" data-tooltip="2024 来啦！" aria-label="下一篇: 2024 来啦！"><span class="hide-xs hide-sm text-small icon-mr">下一篇</span> <i class="fa fa-angle-right" aria-hidden="true"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Diesen Beitrag teilen"><i class="fa fa-share-alt" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://www.mbrjun.cn/archives/496/" title="分享到 Twitter" aria-label="分享到 Twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://www.mbrjun.cn/archives/496/" title="分享到 Weibo" aria-label="分享到 Weibo"><i class="fab fa-weibo" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://www.mbrjun.cn/archives/496/&amp;title=针对 LUKS 自动解锁的冷启动攻击" title="分享到 QQ" aria-label="分享到 QQ"><i class="fab fa-qq" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.mbrjun.cn/archives/496/" title="分享到 Qzone" aria-label="分享到 Qzone"><i class="fa fa-star" aria-hidden="true"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben"><i class="fa fa-list" aria-hidden="true"></i></a></li></ul></div></div><div id="share-options-bar" class="share-options-bar" data-behavior="2"><i id="btn-close-shareoptions" class="fa fa-times"></i><ul class="share-options"><li class="share-option"><a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https://www.mbrjun.cn/archives/496/" aria-label="分享到 Twitter"><i class="fab fa-twitter" aria-hidden="true"></i><span>分享到 Twitter</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://www.mbrjun.cn/archives/496/" aria-label="分享到 Weibo"><i class="fab fa-weibo" aria-hidden="true"></i><span>分享到 Weibo</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://www.mbrjun.cn/archives/496/&amp;title=针对 LUKS 自动解锁的冷启动攻击" aria-label="分享到 QQ"><i class="fab fa-qq" aria-hidden="true"></i><span>分享到 QQ</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.mbrjun.cn/archives/496/" aria-label="分享到 Qzone"><i class="fa fa-star" aria-hidden="true"></i><span>分享到 Qzone</span></a></li></ul></div></div><div id="about"><div id="about-card"><div id="about-btn-close"><i class="fa fa-times"></i></div><img id="about-card-picture" src="https://cos.mbrjun.cn/PICS/LG4v3avatar144px.jpg" alt="作者的图片"><h4 id="about-card-name">MBRjun</h4><div id="about-card-bio"><p>我们生活在大地上，但我们的梦想超越天空</p></div><div id="about-card-job"><i class="fa fa-briefcase"></i><br><p>学生</p></div><div id="about-card-location"><i class="fa fa-map-marker-alt"></i><br>地球</div></div></div><div id="cover" style="background-image:url('https://cos.mbrjun.cn/IMGS/2023/03/23/4419f34e-9353-4b44-a6dd-ebb1db958fc5.webp');"></div><!-- 
█▀▄▀█ █▄▄ █▀█ ░░█ █░█ █▄░█ ▄▄ █▄▄ █░░ █▀█ █▀▀
█░▀░█ █▄█ █▀▄ █▄█ █▄█ █░▀█ ░░ █▄█ █▄▄ █▄█ █▄█
MBRjun-Blog 2024 - with Hexo 7 - tk-mbr NYA-
Commit 972fa94119cd818bad8e98d0faf8a93bc7603c31
Build on: runner@Azure-GitHub-Actions (running kernel: 6.5.0-1023-azure)
Date: 2024-07-10 Preset: CI --></body></html>