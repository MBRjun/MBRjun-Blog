<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="MBRjun-Blog"><title>适用于 mlx5 网卡的 Linux SR-IOV 配置教程 - MBRjun-Blog</title><meta name="author" content="MBRjun"><meta name="keywords" content="MBRjun,Linux,服务器,软路由,PVE,原神,maimai,JavaScript,Windows,Microsoft,git,Node.JS,"><link rel="icon" href="https://lfs.libmbr.com/assets/pics/LG4v5Ravatar180px.webp"><link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml"><script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"MBRjun","sameAs":["https://github.com/MBRjun","https://twitter.com/MBRjun","mailto:neko@mbr.moe"],"image":"https://lfs.libmbr.com/assets/pics/LG4v5Ravatar180px.webp"},"articleBody":"为基于使用 mlx5 驱动的网卡写一个 Linux 上的 SR-IOV 教程，顺带写一点遇到的问题。  \n\n\nmlx5 网卡列表mlx5 是 mlx5_core 驱动的简称，使用此驱动的网卡主要是 NVIDIA Mellanox ConnectX-4 或者更新的系列，具体应该有下面这些，其中常见网卡型号有：CX4121A、CX542B\n\nConnectX-4\nConnectX-4 Lx\nConnectX-5\nConnectX-6\nConnectX-6 Dx\nConnectX-7\n\n查看网卡使用的驱动，使用该命令：lspci -nnk | grep -A3 -i eth\n开启 SR-IOV重启设备可能会导致下面的更改被复原。请参考文章后半部分的 固化 章节来持久化配置。\n\n\n先使用 lspci | grep Mellanox 查找网卡的 PCI 设备位置\n12345$ lspci | grep Mellanox01:00.0 Ethernet controller ... [ConnectX-6]01:00.1 Ethernet controller ... [ConnectX-6]02:00.0 Ethernet controller ... [ConnectX-6]02:00.1 Ethernet controller ... [ConnectX-6]\n以上是插入了 2 块 CX6 网卡、每块网卡有 2 个网络接口的典型输出。通过 PCI 设备 ID 可看出前两个、后两个设备都分别是同一张网卡的不同接口。  \n然后我们使用下面的命令来开启 SR-IOV：\n1echo 4 &gt; /sys/bus/pci/devices/0000\\:01\\:00.0/sriov_numvfs\n\n将 4 替换为你需要的 SR-IOV VF 数量，然后将 0000\\:01\\:00.0 替换为网卡接口的 PCI 位置（这里通常可以用 Tab 补全）\n有多个网卡或接口时，对每个接口分别设置。\n若要撤销更改（删除 SR-IOV 设备），将 VF 数量设为 0。\n执行这条命令时卡了很久？此命令执行耗时一般不会太长（每个 VF 大约需要不到 1 秒来配置），但是在少数机器上，此命令可能需要几分钟甚至几个小时才能完成，且执行完成后部分 VF 不能正常使用。\n此故障一般是主板问题导致：你的设备不完整支持 ARI，后期我会单独写一篇文章解释。\n解决方案：确保每张网卡（不是每个端口）的 VF 数不超过 6，或者换个主板\n\n\nPCI 设备路径开始之前，先普及一下 PCI 设备路径的组成（如果你已经有了此部分知识，跳过本章）：\nPCI 设备路径（也有 PCI 位置 或者类似的称呼）类似 0000:01:00.0，是由冒号分隔的十六进制数，每一段的含义是：  \n1[domain:]&lt;bus&gt;:&lt;device&gt;[.function]\n具体的：\n\nDomain（域）：多数系统只有一个 domain 即 0000（例外一般是虚拟机），用于支持大型系统或多个 PCI host bridge。\nBus Number（总线）：PCI 总线的编号，主板上的每个 PCI 控制器或桥接芯片可能生成一个或多个总线。\nDevice Number（设备）：该总线上的设备编号（通常为 0～31），一个总线最多可挂载 32 个设备。\nFunction Number（功能）：该设备的功能号（0～7），一个设备最多支持 8 个功能。\n\n其中 domain 有时可以省略（指代默认的 0000），function 有时也可以省略（指代该设备的全部 function）\nVF 的 PCI 位置此章节只有演示讲解，你不需要执行任何查询信息以外的命令\n\n\n为了方便解释，本节展示使用 1 张双接口网卡（两个 PF），对每个接口开启 4 个 VF 进行 SR-IOV 的配置。\n为两个 PF 分别创建 4 个 VF：\n12echo 4 &gt; /sys/bus/pci/devices/0000\\:01\\:00.0/sriov_numvfsecho 4 &gt; /sys/bus/pci/devices/0000\\:01\\:00.1/sriov_numvfs\n\n创建后重新使用 lspci | grep Mellanox 查找网卡的 PCI 设备位置\n1234567891011$ lspci | grep Mellanox01:00.0 Ethernet controller ... [ConnectX-6] # 端口 001:00.1 Ethernet controller ... [ConnectX-6] # 端口 101:00.2 Ethernet controller ... [ConnectX-6 Virtual Function]01:00.3 Ethernet controller ... [ConnectX-6 Virtual Function]01:00.4 Ethernet controller ... [ConnectX-6 Virtual Function]01:00.5 Ethernet controller ... [ConnectX-6 Virtual Function]01:00.6 Ethernet controller ... [ConnectX-6 Virtual Function]01:00.7 Ethernet controller ... [ConnectX-6 Virtual Function]01:01.0 Ethernet controller ... [ConnectX-6 Virtual Function]01:01.1 Ethernet controller ... [ConnectX-6 Virtual Function]\n\n可以看到 VF 已经成功创建（01:00.2 到 01:01.1）。\n由于 PCI 每个设备只能拥有 8 个功能，PCIe 3.0 引入了 ARI 技术，原理大体上是将设备和功能合并到一起，功能数量从 8 个扩展到 256 个。\n使用 ARI 后，01:00.0 网卡创建的第 9 个功能路径会显示为 01:01.0（功能号满 8 就对设备号进位）\n由于上面我们先对端口 0 设置 4 个 VF，然后再是端口 1，所以按顺序：01:00.2 到 01:00.5 是端口 0 的 VF，其余则是端口 1 的 VF。VF 设备路径的顺序取决于创建 VF 时命令执行顺序。\nSR-IOV 下的网卡名默认规则产生的网卡名会比较长，如果你觉得有必要，可以自己设置个网卡命名规则（具体方法后续补充在这里）。\n默认规则下：\n\nPF一般命名类似 enp1s0f0np0p[PCI Bus ID]s[PCI Device ID]f[PCI Function ID]n[pX]n 后面（pX）是网卡驱动提供的网卡名字段，从 0 开始\nVF一般命名类似 enp1s0f0npf0vf1p[PCI Bus ID]s[PF PCI Device ID]f[PF PCI Function ID]n[pfXvfY]前面使用 PF 的 ID，n 后面（pfXvfY）同样是网卡驱动提供的网卡名字段，从 0 开始\n\n为 VF 设置 MAC 地址重启设备可能会导致下面的更改被复原。请参考文章后半部分的 固化 章节来持久化配置。\n\n\n如果该 VF 需要直接在宿主机使用，或者用于容器如 LXC，使用该命令：ip link set dev &lt;VF 网卡名&gt; address AA:BB:CC:DD:EE:FF执行此命令需要确保 VF 已经加载驱动（默认已加载）\n如果该 VF 用于 QEMU 虚拟机（包括 KVM、Proxmox 等），使用该命令：ip link set &lt;PF 网卡名&gt; vf &lt;VF ID&gt; AA:BB:CC:DD:EE:FFVF ID 即该 PF 上的第 n 个 VF，从 0 开始如果已加载驱动，重新加载驱动后才能在宿主机生效（虚拟机上使用不需要关心这个）\n\n配置 E-Switch 分载ConnectX-5 或更新的网卡支持 E-Switch 分载功能，可以部分改善 PF-VF 的交换性能并降低占用，并解决部分情况下宿主机 VF 无法和虚拟机 VF 正常通信的问题，可以按下面的方法开启 E-Switch 分载：  \n重启设备可能会导致下面的更改被复原。请参考文章后半部分的 固化 章节来持久化配置。\n\n已知问题开启 E-Switch 分载会导致 FreeBSD 无法加载 VF 网卡驱动。目前未找到解决方案。\n\n\n1devlink dev eswitch set pci/0000:01:00.0 mode switchdev\n替换 0000:01:00.0 为实际 PF 的设备路径。\n若要撤销更改，将 switchdev 替换为 legacy 执行。\n执行前，请确保没有 VF 正在使用，否则卸载 VF 时会报错。建议在创建 VF 之前就执行此操作。\n配合 OpenVSwitch(OvS) 使用时，建议执行：\n重启设备不会导致下面的更改被复原。该命令不需要固化。\n\n1ovs-vsctl set Open_vSwitch . other_config:hw-offload=true\n若要撤销更改，使用：\n1ovs-vsctl remove Open_vSwitch . other_config hw-offload\n\nProxmox VE 中 VM 添加 SR-IOV 网卡1qm set VMID -hostpci0 0000:01:00.2,pcie=1\nVMID 替换为虚拟机的 ID，hostpci0 中的 0 替换为虚拟机内 PCI 设备位置（没有什么具体要求，数字不冲突即可），0000:01:00.2 替换为 VF 的 PCI 位置。\n也可以通过网页后台来配置：\n  \nProxmox VE 中 LXC 添加 SR-IOV 网卡123lxc.net.0.name: lxclxc.net.0.type: physlxc.net.0.link: enp1s0f0npf0vf1\nname 字段请随意设置，此参数在使用 SR-IOV 时是个摆设（如果需要设置 LXC 内的网卡名，请直接在宿主机修改 VF 网卡名）；link 设置为 VF 的网卡名\n如果 LXC 内添加了其他网络接口（无论是否是 SR-IOV），请注意 net 后的编号不要冲突  \n固化在 /opt/local-sriov/init.sh 或者你喜欢的地方创建一个脚本：\n123456789101112131415#!/bin/bash# Set E-Switch Offloaddevlink dev eswitch set pci/0000:01:00.0 mode switchdevdevlink dev eswitch set pci/0000:01.00.1 mode switchdev# Create SR-IOV VFs# Config:#   2 VFs on Port 0#   0 VF  on Port 1echo 2 &gt; /sys/bus/pci/devices/0000\\:01\\:00.0/sriov_numvfs# Set IP for each VFip link set ens0f0 vf 0 mac AA:AA:AA:AA:AA:AA # VM 100ip link set dev ens0f0v1 address BB:BB:BB:BB:BB:BB # CT 101\n\n根据实际情况，自行修改脚本中的参数。\nchmod +x /opt/local-sriov/init.sh，然后确保此脚本在接口启动时执行。\n以 ifupdown(2/ng) 为例，修改 /etc/network/interfaces：\n1234auto vmbr0iface vmbr0 inet static        (原配置保持不变)        post-up sleep 5 &amp;&amp; /opt/local-sriov/init.sh\n","dateCreated":"2025-08-01T00:59:00+08:00","dateModified":"2025-08-01T00:59:00+08:00","datePublished":"2025-08-01T00:59:00+08:00","description":"为基于使用 mlx5 驱动的网卡写一个 Linux 上的 SR-IOV 教程，顺带写一点遇到的问题。  ","headline":"适用于 mlx5 网卡的 Linux SR-IOV 配置教程","image":["https://lfs.libmbr.com/assets/2025/08/01/791f8480-d65e-4bff-8e3f-01b432899f45.webp"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.libmbr.com/archives/508/"},"publisher":{"@type":"Organization","name":"MBRjun","sameAs":["https://github.com/MBRjun","https://twitter.com/MBRjun","mailto:neko@mbr.moe"],"image":"https://lfs.libmbr.com/assets/pics/LG4v5Ravatar180px.webp","logo":{"@type":"ImageObject","url":"https://lfs.libmbr.com/assets/pics/LG4v5Ravatar180px.webp"}},"url":"https://www.libmbr.com/archives/508/","keywords":"虚拟化, 网卡, Mellanox, NVIDIA, mlx5, SR-IOV","thumbnailUrl":"https://lfs.libmbr.com/assets/2025/08/01/791f8480-d65e-4bff-8e3f-01b432899f45.webp"}</script><meta name="description" content="为基于使用 mlx5 驱动的网卡写一个 Linux 上的 SR-IOV 教程，顺带写一点遇到的问题。"><meta property="og:type" content="blog"><meta property="og:title" content="适用于 mlx5 网卡的 Linux SR-IOV 配置教程"><meta property="og:url" content="https://www.libmbr.com/archives/508/index.html"><meta property="og:site_name" content="MBRjun-Blog"><meta property="og:description" content="为基于使用 mlx5 驱动的网卡写一个 Linux 上的 SR-IOV 教程，顺带写一点遇到的问题。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://lfs.libmbr.com/assets/2025/08/01/ddb8a43a-27f9-404b-a7c1-02dcef049008.webp"><meta property="article:published_time" content="2025-07-31T16:59:00.000Z"><meta property="article:modified_time" content="2025-07-31T16:59:00.000Z"><meta property="article:author" content="MBRjun"><meta property="article:tag" content="虚拟化"><meta property="article:tag" content="网卡"><meta property="article:tag" content="Mellanox"><meta property="article:tag" content="NVIDIA"><meta property="article:tag" content="mlx5"><meta property="article:tag" content="SR-IOV"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://lfs.libmbr.com/assets/2025/08/01/ddb8a43a-27f9-404b-a7c1-02dcef049008.webp"><meta name="twitter:creator" content="@MBRjun"><meta property="og:image" content="https://lfs.libmbr.com/assets/pics/LG4v5Ravatar180px.webp"><meta property="og:image" content="https://lfs.libmbr.com/assets/2025/08/01/791f8480-d65e-4bff-8e3f-01b432899f45.webp"><meta class="swiftype" name="image" data-type="enum" content="https://lfs.libmbr.com/assets/2025/08/01/791f8480-d65e-4bff-8e3f-01b432899f45.webp"><!--STYLES--><link rel="stylesheet" href="/assets/css/style.min.css?v=e07d1a74f2a4706e25510ef123e13e21401ed19e"><!--STYLES END--><!--SCRIPTS--><script async="" defer="" src="/assets/js/script.min.js?v=e07d1a74f2a4706e25510ef123e13e21401ed19e"></script><!--SCRIPTS END--><!--PRELOAD--><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="//github.githubassets.com"><link rel="dns-prefetch" href="//avatars.githubusercontent.com"><link rel="preconnect" href="https://lfs.libmbr.com"><link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="/assets/fonts/GoogleSansDisplay-BR.woff2"><link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="/assets/fonts/GoogleSansDisplay-LR.woff2"><link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="/assets/fonts/fa-solid-900.woff2"><link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="/assets/fonts/fa-brands-400.woff2"><!--PRELOAD END--><link rel="canonical" href="https://www.libmbr.com/archives/508/"><script>"use strict";var scripts=["/assets/js/webp-polyfill.min.js?v=2.0.1"];function parallelLoadScripts(e,t){"object"!=typeof e&&(e=[e]);for(var n=document.getElementsByTagName("head")[0]||document.documentElement,o=[],l=0,i=0;i<e.length;i++)o[i]=document.createElement("script"),o[i].setAttribute("type","text/javascript"),o[i].onload=o[i].onreadystatechange=function(){l++,this.onload=this.onreadystatechange=null,this.parentNode.removeChild(this),l===e.length&&"function"==typeof t&&t()},o[i].setAttribute("src",e[i]),n.appendChild(o[i])}"ActiveXObject"in window&&parallelLoadScripts(scripts,function(){console.log("[hexo-webp-polyfill] polyfilling document"),(new webpHero.WebpMachine).polyfillDocument()});</script></head><body><div id="blog"><!-- Define author's picture --><header id="header" data-behavior="2"><i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i><div class="header-title"><a class="header-title-link" href="/" aria-label="">MBRjun-Blog</a></div><a class="header-right-picture" href="/about" aria-label="打开链接: /about"><img class="header-picture" src="https://lfs.libmbr.com/assets/pics/LG4v5Ravatar180px.webp" alt="作者的图片"></a></header><!-- Define author's picture --><nav id="sidebar" data-behavior="2"><div class="sidebar-container"><div class="sidebar-profile"><a href="/#about" aria-label="阅读有关作者的更多信息"><img class="sidebar-profile-picture" src="https://lfs.libmbr.com/assets/pics/LG4v5Ravatar180px.webp" alt="作者的图片"></a><h4 class="sidebar-profile-name">MBRjun</h4><h5 class="sidebar-profile-bio"><p>我们生活在大地上，但我们的梦想超越天空</p></h5></div><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/" rel="noopener" title="首页"><i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i> <span class="sidebar-button-desc">首页</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-categories" rel="noopener" title="分类"><i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i> <span class="sidebar-button-desc">分类</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-tags" rel="noopener" title="标签"><i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i> <span class="sidebar-button-desc">标签</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-archives" rel="noopener" title="归档"><i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i> <span class="sidebar-button-desc">归档</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/links" rel="noopener" title="友情链接"><i class="sidebar-button-icon fa fa-link" aria-hidden="true"></i> <span class="sidebar-button-desc">友情链接</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="https://www.travellings.cn/go.html" target="_blank" rel="noopener" title="开往"><i class="sidebar-button-icon fa fa-paper-plane" aria-hidden="true"></i> <span class="sidebar-button-desc">开往</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="https://github.com/MBRjun" target="_blank" rel="noopener" title="GitHub"><i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i> <span class="sidebar-button-desc">GitHub</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="https://twitter.com/MBRjun" target="_blank" rel="noopener" title="Twitter"><i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i> <span class="sidebar-button-desc">Twitter</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="mailto:neko@mbr.moe" target="_blank" rel="noopener" title="邮箱"><i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i> <span class="sidebar-button-desc">邮箱</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/atom.xml" rel="noopener" title="RSS"><i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i> <span class="sidebar-button-desc">RSS</span></a></li></ul></div></nav><div id="main" data-behavior="2" class="hasCoverMetaIn"><article class="post"><div class="post-header main-content-wrap text-left"><h1 class="post-title">适用于 mlx5 网卡的 Linux SR-IOV 配置教程</h1><div class="post-meta"><time datetime="2025-08-01T00:59:00+08:00">2025 年 8 月 1 日 </time><span>发布在 </span><a class="category-link" href="/categories/%E6%95%99%E7%A8%8B/">教程</a></div></div><div class="post-content markdown"><div class="main-content-wrap"><p>为基于使用 mlx5 驱动的网卡写一个 Linux 上的 SR-IOV 教程，顺带写一点遇到的问题。</p><span id="more"></span><h2 id="mlx5-网卡列表"><a href="#mlx5-网卡列表" class="headerlink" title="mlx5 网卡列表"></a>mlx5 网卡列表</h2><p>mlx5 是 <code>mlx5_core</code> 驱动的简称，使用此驱动的网卡主要是 <del>NVIDIA</del> Mellanox ConnectX-4 或者更新的系列，具体应该有下面这些，其中常见网卡型号有：CX4121A、CX542B</p><ul><li>ConnectX-4</li><li>ConnectX-4 Lx</li><li>ConnectX-5</li><li>ConnectX-6</li><li>ConnectX-6 Dx</li><li>ConnectX-7</li></ul><p>查看网卡使用的驱动，使用该命令：<code>lspci -nnk | grep -A3 -i eth</code></p><h2 id="开启-SR-IOV"><a href="#开启-SR-IOV" class="headerlink" title="开启 SR-IOV"></a>开启 SR-IOV</h2><div class="alert info"><p>重启设备可能会导致下面的更改被复原。请参考文章后半部分的 固化 章节来持久化配置。</p></div><p>先使用 <code>lspci | grep Mellanox</code> 查找网卡的 PCI 设备位置</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$ lspci | grep Mellanox<br>01:00.0 Ethernet controller ... [ConnectX-6]<br>01:00.1 Ethernet controller ... [ConnectX-6]<br>02:00.0 Ethernet controller ... [ConnectX-6]<br>02:00.1 Ethernet controller ... [ConnectX-6]<br></code></pre></td></tr></tbody></table></figure><p>以上是插入了 2 块 CX6 网卡、每块网卡有 2 个网络接口的典型输出。通过 PCI 设备 ID 可看出前两个、后两个设备都分别是同一张网卡的不同接口。</p><p>然后我们使用下面的命令来开启 SR-IOV：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">echo 4 &gt; /sys/bus/pci/devices/0000\:01\:00.0/sriov_numvfs<br></code></pre></td></tr></tbody></table></figure><p>将 4 替换为你需要的 SR-IOV VF 数量，然后将 0000\:01\:00.0 替换为网卡接口的 PCI 位置（这里通常可以用 Tab 补全）</p><p>有多个网卡或接口时，对每个接口分别设置。</p><p>若要撤销更改（删除 SR-IOV 设备），将 VF 数量设为 0。</p><div class="alert warning"><p><strong>执行这条命令时卡了很久？</strong><br>此命令执行耗时一般不会太长（每个 VF 大约需要不到 1 秒来配置），但是在少数机器上，此命令可能需要几分钟甚至几个小时才能完成，且执行完成后部分 VF 不能正常使用。</p><p>此故障一般是主板问题导致：你的设备不完整支持 ARI，后期我会单独写一篇文章解释。</p><p>解决方案：确保每张网卡（不是每个端口）的 VF 数不超过 6，或者换个主板</p></div><h2 id="PCI-设备路径"><a href="#PCI-设备路径" class="headerlink" title="PCI 设备路径"></a>PCI 设备路径</h2><p>开始之前，先普及一下 PCI 设备路径的组成（如果你已经有了此部分知识，跳过本章）：</p><p>PCI 设备路径（也有 PCI 位置 或者类似的称呼）类似 <code>0000:01:00.0</code>，是由冒号分隔的十六进制数，每一段的含义是：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">[domain:]&lt;bus&gt;:&lt;device&gt;[.function]<br></code></pre></td></tr></tbody></table></figure><p>具体的：</p><ul><li>Domain（域）：<br>多数系统只有一个 domain 即 0000（例外一般是虚拟机），用于支持大型系统或多个 PCI host bridge。</li><li>Bus Number（总线）：<br>PCI 总线的编号，主板上的每个 PCI 控制器或桥接芯片可能生成一个或多个总线。</li><li>Device Number（设备）：<br>该总线上的设备编号（通常为 0～31），一个总线最多可挂载 32 个设备。</li><li>Function Number（功能）：<br>该设备的功能号（0～7），一个设备最多支持 8 个功能。</li></ul><p>其中 domain 有时可以省略（指代默认的 0000），function 有时也可以省略（指代该设备的全部 function）</p><h2 id="VF-的-PCI-位置"><a href="#VF-的-PCI-位置" class="headerlink" title="VF 的 PCI 位置"></a>VF 的 PCI 位置</h2><div class="alert info"><p>此章节只有演示讲解，你不需要执行任何查询信息以外的命令</p></div><p>为了方便解释，本节展示使用 1 张双接口网卡（两个 PF），对每个接口开启 4 个 VF 进行 SR-IOV 的配置。</p><p>为两个 PF 分别创建 4 个 VF：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">echo 4 &gt; /sys/bus/pci/devices/0000\:01\:00.0/sriov_numvfs<br>echo 4 &gt; /sys/bus/pci/devices/0000\:01\:00.1/sriov_numvfs<br></code></pre></td></tr></tbody></table></figure><p>创建后重新使用 <code>lspci | grep Mellanox</code> 查找网卡的 PCI 设备位置</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$ lspci | grep Mellanox<br>01:00.0 Ethernet controller ... [ConnectX-6] # 端口 0<br>01:00.1 Ethernet controller ... [ConnectX-6] # 端口 1<br>01:00.2 Ethernet controller ... [ConnectX-6 Virtual Function]<br>01:00.3 Ethernet controller ... [ConnectX-6 Virtual Function]<br>01:00.4 Ethernet controller ... [ConnectX-6 Virtual Function]<br>01:00.5 Ethernet controller ... [ConnectX-6 Virtual Function]<br>01:00.6 Ethernet controller ... [ConnectX-6 Virtual Function]<br>01:00.7 Ethernet controller ... [ConnectX-6 Virtual Function]<br>01:01.0 Ethernet controller ... [ConnectX-6 Virtual Function]<br>01:01.1 Ethernet controller ... [ConnectX-6 Virtual Function]<br></code></pre></td></tr></tbody></table></figure><p>可以看到 VF 已经成功创建（<code>01:00.2</code> 到 <code>01:01.1</code>）。</p><p>由于 PCI 每个设备只能拥有 8 个功能，PCIe 3.0 引入了 ARI 技术，原理大体上是将设备和功能合并到一起，功能数量从 8 个扩展到 256 个。</p><p>使用 ARI 后，<code>01:00.0</code> 网卡创建的第 9 个功能路径会显示为 <code>01:01.0</code>（功能号满 8 就对设备号进位）</p><p>由于上面我们先对端口 0 设置 4 个 VF，然后再是端口 1，所以按顺序：<code>01:00.2</code> 到 <code>01:00.5</code> 是端口 0 的 VF，其余则是端口 1 的 VF。VF 设备路径的顺序取决于创建 VF 时命令执行顺序。</p><h2 id="SR-IOV-下的网卡名"><a href="#SR-IOV-下的网卡名" class="headerlink" title="SR-IOV 下的网卡名"></a>SR-IOV 下的网卡名</h2><p>默认规则产生的网卡名会比较长，如果你觉得有必要，可以自己设置个网卡命名规则（具体方法后续补充在这里）。</p><p>默认规则下：</p><ul><li>PF<br>一般命名类似 <code>enp1s0f0np0</code><br>p[PCI Bus ID]s[PCI Device ID]f[PCI Function ID]n[pX]<br>n 后面（pX）是网卡驱动提供的网卡名字段，从 0 开始</li><li>VF<br>一般命名类似 <code>enp1s0f0npf0vf1</code><br>p[PCI Bus ID]s[PF PCI Device ID]f[PF PCI Function ID]n[pfXvfY]<br>前面使用 PF 的 ID，n 后面（pfXvfY）同样是网卡驱动提供的网卡名字段，从 0 开始</li></ul><h2 id="为-VF-设置-MAC-地址"><a href="#为-VF-设置-MAC-地址" class="headerlink" title="为 VF 设置 MAC 地址"></a>为 VF 设置 MAC 地址</h2><div class="alert info"><p>重启设备可能会导致下面的更改被复原。请参考文章后半部分的 固化 章节来持久化配置。</p></div><ul><li>如果该 VF 需要直接在宿主机使用，或者用于容器如 LXC，使用该命令：<br><code>ip link set dev &lt;VF 网卡名&gt; address AA:BB:CC:DD:EE:FF</code><br>执行此命令需要确保 VF 已经加载驱动（默认已加载）</li><li>如果该 VF 用于 QEMU 虚拟机（包括 KVM、Proxmox 等），使用该命令：<br><code>ip link set &lt;PF 网卡名&gt; vf &lt;VF ID&gt; AA:BB:CC:DD:EE:FF</code><br>VF ID 即该 PF 上的第 n 个 VF，从 0 开始<br>如果已加载驱动，重新加载驱动后才能在宿主机生效（虚拟机上使用不需要关心这个）</li></ul><h2 id="配置-E-Switch-分载"><a href="#配置-E-Switch-分载" class="headerlink" title="配置 E-Switch 分载"></a>配置 E-Switch 分载</h2><p>ConnectX-5 或更新的网卡支持 E-Switch 分载功能，可以部分改善 PF-VF 的交换性能并降低占用，并解决部分情况下宿主机 VF 无法和虚拟机 VF 正常通信的问题，可以按下面的方法开启 E-Switch 分载：</p><div class="alert info"><p>重启设备可能会导致下面的更改被复原。请参考文章后半部分的 固化 章节来持久化配置。</p></div><div class="alert warning"><p><strong>已知问题</strong><br>开启 E-Switch 分载会导致 FreeBSD 无法加载 VF 网卡驱动。<br>目前未找到解决方案。</p></div><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">devlink dev eswitch set pci/0000:01:00.0 mode switchdev<br></code></pre></td></tr></tbody></table></figure><p>替换 0000:01:00.0 为实际 PF 的设备路径。</p><p>若要撤销更改，将 switchdev 替换为 legacy 执行。</p><p>执行前，请确保没有 VF 正在使用，否则卸载 VF 时会报错。建议在创建 VF 之前就执行此操作。</p><p>配合 OpenVSwitch(OvS) 使用时，建议执行：</p><div class="alert info"><p>重启设备不会导致下面的更改被复原。该命令不需要固化。</p></div><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">ovs-vsctl set Open_vSwitch . other_config:hw-offload=true<br></code></pre></td></tr></tbody></table></figure><p>若要撤销更改，使用：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">ovs-vsctl remove Open_vSwitch . other_config hw-offload<br></code></pre></td></tr></tbody></table></figure><h2 id="Proxmox-VE-中-VM-添加-SR-IOV-网卡"><a href="#Proxmox-VE-中-VM-添加-SR-IOV-网卡" class="headerlink" title="Proxmox VE 中 VM 添加 SR-IOV 网卡"></a>Proxmox VE 中 VM 添加 SR-IOV 网卡</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">qm set VMID -hostpci0 0000:01:00.2,pcie=1<br></code></pre></td></tr></tbody></table></figure><p>VMID 替换为虚拟机的 ID，hostpci0 中的 0 替换为虚拟机内 PCI 设备位置（没有什么具体要求，数字不冲突即可），0000:01:00.2 替换为 VF 的 PCI 位置。</p><p>也可以通过网页后台来配置：</p><p><img src="https://lfs.libmbr.com/assets/2025/08/01/ddb8a43a-27f9-404b-a7c1-02dcef049008.webp" alt="Proxmox add PCIe"></p><h2 id="Proxmox-VE-中-LXC-添加-SR-IOV-网卡"><a href="#Proxmox-VE-中-LXC-添加-SR-IOV-网卡" class="headerlink" title="Proxmox VE 中 LXC 添加 SR-IOV 网卡"></a>Proxmox VE 中 LXC 添加 SR-IOV 网卡</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">lxc.net.0.name: lxc<br>lxc.net.0.type: phys<br>lxc.net.0.link: enp1s0f0npf0vf1<br></code></pre></td></tr></tbody></table></figure><p><code>name</code> 字段请随意设置，此参数在使用 SR-IOV 时是个摆设（如果需要设置 LXC 内的网卡名，请直接在宿主机修改 VF 网卡名）；<code>link</code> 设置为 VF 的网卡名</p><p>如果 LXC 内添加了其他网络接口（无论是否是 SR-IOV），请注意 net 后的编号不要冲突</p><h2 id="固化"><a href="#固化" class="headerlink" title="固化"></a>固化</h2><p>在 <code>/opt/local-sriov/init.sh</code> 或者你喜欢的地方创建一个脚本：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment"># Set E-Switch Offload</span><br>devlink dev eswitch <span class="hljs-built_in">set</span> pci/0000:01:00.0 mode switchdev<br>devlink dev eswitch <span class="hljs-built_in">set</span> pci/0000:01.00.1 mode switchdev<br><br><span class="hljs-comment"># Create SR-IOV VFs</span><br><span class="hljs-comment"># Config:</span><br><span class="hljs-comment">#   2 VFs on Port 0</span><br><span class="hljs-comment">#   0 VF  on Port 1</span><br><span class="hljs-built_in">echo</span> 2 &gt; /sys/bus/pci/devices/0000\:01\:00.0/sriov_numvfs<br><br><span class="hljs-comment"># Set IP for each VF</span><br>ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> ens0f0 vf 0 mac AA:AA:AA:AA:AA:AA <span class="hljs-comment"># VM 100</span><br>ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> dev ens0f0v1 address BB:BB:BB:BB:BB:BB <span class="hljs-comment"># CT 101</span><br></code></pre></td></tr></tbody></table></figure><p>根据实际情况，自行修改脚本中的参数。</p><p><code>chmod +x /opt/local-sriov/init.sh</code>，然后确保此脚本在接口启动时执行。</p><p>以 <code>ifupdown(2/ng)</code> 为例，修改 <code>/etc/network/interfaces</code>：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">auto vmbr0<br>iface vmbr0 inet static<br>        (原配置保持不变)<br>        post-up sleep 5 &amp;&amp; /opt/local-sriov/init.sh<br></code></pre></td></tr></tbody></table></figure></div></div><div id="post-footer" class="post-footer main-content-wrap"><div class="post-footer-tags"><span class="text-color-light text-small">标签</span><br><a class="tag tag--primary tag--small t-none-link" href="/tags/Mellanox/" rel="tag">Mellanox</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/NVIDIA/" rel="tag">NVIDIA</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/SR-IOV/" rel="tag">SR-IOV</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/mlx5/" rel="tag">mlx5</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/%E7%BD%91%E5%8D%A1/" rel="tag">网卡</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/" rel="tag">虚拟化</a></div><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/archives/509/" data-tooltip="Proxmox VE 9 升级" aria-label="上一篇: Proxmox VE 9 升级"><i class="fa fa-angle-left" aria-hidden="true"></i> <span class="hide-xs hide-sm text-small icon-ml">上一篇</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/archives/507/" data-tooltip="北京地铁银行卡乘车全攻略" aria-label="下一篇: 北京地铁银行卡乘车全攻略"><span class="hide-xs hide-sm text-small icon-mr">下一篇</span> <i class="fa fa-angle-right" aria-hidden="true"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Diesen Beitrag teilen"><i class="fa fa-share-alt" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://www.libmbr.com/archives/508/" title="分享到 Twitter" aria-label="分享到 Twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://www.libmbr.com/archives/508/" title="分享到 Weibo" aria-label="分享到 Weibo"><i class="fab fa-weibo" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://www.libmbr.com/archives/508/&amp;title=适用于 mlx5 网卡的 Linux SR-IOV 配置教程" title="分享到 QQ" aria-label="分享到 QQ"><i class="fab fa-qq" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.libmbr.com/archives/508/" title="分享到 Qzone" aria-label="分享到 Qzone"><i class="fa fa-star" aria-hidden="true"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben"><i class="fa fa-list" aria-hidden="true"></i></a></li></ul></div><script src="https://hiroko.libmbr.com/client.js" data-repo="MBRjun/MBRjun-Blog" data-repo-id="R_kgDOIbI33Q" data-category="Blog" data-category-id="DIC_kwDOIbI33c4CTUTq" data-mapping="title" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light_tritanopia" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async=""></script></div></article><footer id="footer" class="main-content-wrap"><span class="copyrights"><a target="_blank" rel="noopener" href="https://github.com/MBRjun/MBRjun-Blog">GitHub 源代码</a> - <a target="_blank" rel="noopener" href="https://github.com/MBRjun/MBRjun-Blog/blob/main/LICENSE">LICENSE(CC BY-SA 3)</a><br></span><span class="text-small"><a target="_blank" href="https://beian.miit.gov.cn" rel="nofollow noopener">闽ICP备2025085162号-4</a> - <a target="_blank" href="http://www.beian.gov.cn" rel="nofollow noopener">津公网安备12010102001086号</a><br></span><span class="copyrights">Copyrights © 2025 MBRjun. All Rights Reserved.</span></footer><script async="" defer="" data-website-id="8bccd081-57f0-4d61-908d-38e37d47241d" src="https://hotaru.libmbr.com/hotaru.js?v=20250329-1" data-tag="MBRjun-Blog"></script></div><div id="bottom-bar" class="post-bottom-bar" data-behavior="2"><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/archives/509/" data-tooltip="Proxmox VE 9 升级" aria-label="上一篇: Proxmox VE 9 升级"><i class="fa fa-angle-left" aria-hidden="true"></i> <span class="hide-xs hide-sm text-small icon-ml">上一篇</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/archives/507/" data-tooltip="北京地铁银行卡乘车全攻略" aria-label="下一篇: 北京地铁银行卡乘车全攻略"><span class="hide-xs hide-sm text-small icon-mr">下一篇</span> <i class="fa fa-angle-right" aria-hidden="true"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Diesen Beitrag teilen"><i class="fa fa-share-alt" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://www.libmbr.com/archives/508/" title="分享到 Twitter" aria-label="分享到 Twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://www.libmbr.com/archives/508/" title="分享到 Weibo" aria-label="分享到 Weibo"><i class="fab fa-weibo" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://www.libmbr.com/archives/508/&amp;title=适用于 mlx5 网卡的 Linux SR-IOV 配置教程" title="分享到 QQ" aria-label="分享到 QQ"><i class="fab fa-qq" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.libmbr.com/archives/508/" title="分享到 Qzone" aria-label="分享到 Qzone"><i class="fa fa-star" aria-hidden="true"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben"><i class="fa fa-list" aria-hidden="true"></i></a></li></ul></div></div><div id="share-options-bar" class="share-options-bar" data-behavior="2"><i id="btn-close-shareoptions" class="fa fa-times"></i><ul class="share-options"><li class="share-option"><a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https://www.libmbr.com/archives/508/" aria-label="分享到 Twitter"><i class="fab fa-twitter" aria-hidden="true"></i><span>分享到 Twitter</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://www.libmbr.com/archives/508/" aria-label="分享到 Weibo"><i class="fab fa-weibo" aria-hidden="true"></i><span>分享到 Weibo</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://www.libmbr.com/archives/508/&amp;title=适用于 mlx5 网卡的 Linux SR-IOV 配置教程" aria-label="分享到 QQ"><i class="fab fa-qq" aria-hidden="true"></i><span>分享到 QQ</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.libmbr.com/archives/508/" aria-label="分享到 Qzone"><i class="fa fa-star" aria-hidden="true"></i><span>分享到 Qzone</span></a></li></ul></div></div><div id="about"><div id="about-card"><div id="about-btn-close"><i class="fa fa-times"></i></div><img id="about-card-picture" src="https://lfs.libmbr.com/assets/pics/LG4v5Ravatar180px.webp" alt="作者的图片"><h4 id="about-card-name">MBRjun</h4><div id="about-card-bio"><p>我们生活在大地上，但我们的梦想超越天空</p></div><div id="about-card-job"><i class="fa fa-briefcase"></i><br><p>学生</p></div><div id="about-card-location"><i class="fa fa-map-marker-alt"></i><br>地球</div></div></div><div id="cover" style="background-image:url('https://lfs.libmbr.com/assets/2023/03/23/4419f34e-9353-4b44-a6dd-ebb1db958fc5.webp');"></div><!-- 
█▀▄▀█ █▄▄ █▀█ ░░█ █░█ █▄░█ ▄▄ █▄▄ █░░ █▀█ █▀▀
█░▀░█ █▄█ █▀▄ █▄█ █▄█ █░▀█ ░░ █▄█ █▄▄ █▄█ █▄█
MBRjun-Blog 2025 - with Hexo 7 - tk-mbr NYA-
Commit e07d1a74f2a4706e25510ef123e13e21401ed19e
Build on: runner@pkrvm7jw40e0xgp (running kernel: 6.11.0-1018-azure)
Date: 2025-09-03 Preset: CI --></body></html>