<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="MBRjun-Blog"><title>将 Debian 的根目录 FS 切换为 ZFS - MBRjun-Blog</title><meta name="author" content="MBRjun"><meta name="keywords" content="MBRjun,Linux,服务器,软路由,PVE,原神,maimai,JavaScript,Windows,Microsoft,git,Node.JS,"><link rel="icon" href="https://cos.mbrjun.cn/PICS/LG4v3avatar144px.jpg"><link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml"><script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"MBRjun","sameAs":["https://github.com/MBRjun","https://twitter.com/MBRjun","mailto:neko@mbr.moe"],"image":"https://cos.mbrjun.cn/PICS/LG4v3avatar144px.jpg"},"articleBody":"Linux 更换根目录的 FS 为 ZFS 是可行的，写一篇教程记录下大致步骤和可能出现的问题  \n\n\n准备\n不比系统盘小的一块空硬盘\n\n操作过程1 - ZFS 驱动和工具Debian 目前默认的内核并没有集成 ZFS 驱动，必须更换内核或者手动安装内核模块才能正常使用 ZFS  \n方法一\n这里可以直接安装 proxmox-ve 包，Proxmox VE 自带了 ZFS 的管理工具和驱动（驱动由 Proxmox VE 的定制内核提供）， 且 PVE 对 ZFS 的支持也非常全： \n如果你安装了 qemu，此方法会将你的 qemu 替换为 PVE 修改后的版本\n\n\n如果你使用 systemd-timesyncd 用于时间同步，此方法会将你的 systemd-timesyncd 替换为 chrony\n\n\n下面的安装命令仅适用于 Debian 12 Bookworm AMD64，其他 Debian 版本或其他架构无法使用\n\n\n1234567echo &quot;deb [arch=amd64] http://download.proxmox.com/debian/pve bookworm pve-no-subscription&quot; &gt; /etc/apt/sources.list.d/pve-install-repo.listwget https://enterprise.proxmox.com/debian/proxmox-release-bookworm.gpg -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg apt updateapt install proxmox-default-kernel proxmox-ve postfix open-iscsi chrony -yapt remove linux-image-amd64 &#x27;linux-image-6.1*&#x27; -yupdate-grubsystemctl reboot\n\n如果只使用 Proxmox VE 的 ZFS 管理工具和驱动，不使用 Proxmox VE 虚拟机，可以考虑把 proxmox-ve 卸载掉：apt remove proxmox-ve -y\n方法二\n使用原有内核，不安装 proxmox-ve 或其他内核，使用 dkms 手动安装 ZFS 驱动\n此方法可能无法在启用了 UEFI 安全启动的设备上正常工作，原因如下：  \nLinux 5.4 中添加了 kernel_lockdown 功能，在启用 UEFI 安全启动的设备上，kernel_lockdown 强制启用，此功能只能在内核编译时去掉  \nkernel_lockdown 会阻止系统载入未签名的自定义模块，zfs-dkms 就是未签名的模块  \n您必须为内核和 dkms 配置自定义签名才能在启用了 UEFI 安全启动的设备上使用此方法（流程非常复杂，可能还需要在 UEFI 固件设置里手动导入证书，能单独再写一篇文章了）\n\n\n12apt install linux-headers-amd64 zfsutils-linux zfs-dkmsmodprobe zfs\n\n2 - 复制磁盘数据假设原硬盘的分区结构如下：  \n\n    \n        vda\n    \n    \n        1\n        2\n        3\n        \n    \n    \n        BIOS Boot\n        Linux filesystem\n        Linux LVM\n        \n    \n    \n        \n        ext4 /boot\n        VG system\n        \n    \n    \n        \n        \n        root\n        swap\n    \n    \n        \n        \n        btrfs /\n        swap\n    \n\n\n先把系统盘（以 vda 为例）复制到另一块盘 vdb，然后清除掉 vdb 上的 boot 和 root 分区\n如果你的系统盘上有 LVM，你需要在磁盘克隆后使用 vgimportclone 重新生成 LVM 的 UUID，命令已在下方给出\n\n\nUEFI 用户需要两个分区用于启动，一个是 ESP（应挂载到 &#x2F;boot&#x2F;efi），另一个是 ZFS 启动分区（应挂载到 &#x2F;boot），我只以传统引导演示，因为我不使用 UEFI 也没有 ESP（\n\n\n12345vgrename system systemOlddd if=/dev/vda of=/dev/vdb bs=1M status=progressvgimportclone /dev/vdb3 -n system # regen LVM uuidswipefs -a /dev/vdb2wipefs -a /dev/system/root\n\n完成后磁盘分区结构大致是：  \n\n    \n        vdb\n    \n    \n        1\n        2\n        3\n        \n    \n    \n        BIOS Boot\n        Linux filesystem\n        Linux LVM\n        \n    \n    \n        \n        \n        VG system\n        \n    \n    \n        \n        \n        root\n        swap\n    \n    \n        \n        \n        \n        swap\n    \n\n\n3 - 创建 ZFSbpool，用于引导：  \n12345678910111213141516171819202122zpool create \\    -f \\    -o cachefile= \\    -o ashift=12 -d \\    -o feature@async_destroy=enabled \\    -o feature@bookmarks=enabled \\    -o feature@embedded_data=enabled \\    -o feature@empty_bpobj=enabled \\    -o feature@enabled_txg=enabled \\    -o feature@extensible_dataset=enabled \\    -o feature@filesystem_limits=enabled \\    -o feature@hole_birth=enabled \\    -o feature@large_blocks=enabled \\    -o feature@livelist=enabled \\    -o feature@lz4_compress=enabled \\    -o feature@spacemap_histogram=enabled \\    -o feature@zpool_checkpoint=enabled \\    -O acltype=posixacl -O canmount=off -O compression=lz4 \\    -O devices=off -O normalization=formD -O relatime=on -O xattr=sa \\    -O mountpoint=/boot -R /mnt \\    bpool \\    /dev/vdb2\n\nrpool，存储 rootfs：\n12345678zpool create \\    -f \\    -o ashift=12 \\    -O acltype=posixacl -O canmount=off -O compression=lz4 \\    -O normalization=formD -O relatime=on \\    -O xattr=sa -O mountpoint=/ -R /mnt \\    rpool \\    /dev/system/root\n\n创建数据集：\n123zfs create -o canmount=noauto -o mountpoint=/ rpool/ROOT/proxmoxzfs mount rpool/ROOT/proxmoxzfs create -o mountpoint=/boot bpool/BOOT/proxmox\n\n上面的操作完成后磁盘分区结构大致是：  \n\n    \n        vdb\n    \n    \n        1\n        2\n        3\n        \n    \n    \n        BIOS Boot\n        Linux filesystem\n        Linux LVM\n        \n    \n    \n        \n        zpool bpool\n        VG system\n        \n    \n    \n        \n        BOOT\n        zpool rpool\n        swap\n    \n    \n        \n        zfs /boot\n        ROOT\n        swap\n    \n    \n        \n        \n        zfs /\n        \n    \n\n\n4 - 拷贝文件123apt install rsync -yrsync -axHAWXS --numeric-ids --info=progress2 / /mntrsync -axHAWXS --numeric-ids --info=progress2 /boot /mnt\n\n5 - 更新引导在 vdb 创建新的引导文件：  \n12345678mount --rbind /proc /mnt/procmount --rbind /sys /mnt/sysmount --rbind /dev /mnt/devchroot /mntapt install zfs-initramfs -yupdate-initramfs -c -k allgrub-install /dev/vdbupdate-grub\n\n6 - 更新 fstabZFS 不依赖 fstab 挂载，挂载信息存储在文件系统中，自行清理 fstab 的无用条目\n7 - 导出 ZFS1234exit # quit chrootmount | grep -v zfs | tac | awk &#x27;/\\/mnt/ &#123;print $3&#125;&#x27; | \\    xargs -i&#123;&#125; umount -lf &#123;&#125;zpool export -a\n\n8 - 将 ZFS 写回原系统盘方法一\n如果有 LiveCD，直接进 LiveCD 执行：\n1dd if=/dev/vdb of=/dev/vda status=progress\n\n方法二\n如果没有 LiveCD，则将根目录系统挂载为只读，然后再复制：\n123mount -o remount,ro / # soft remount roecho u &gt; /proc/sysrq-trigger # force remount ro, not work in btrfsdd if=/dev/vdb of=/dev/vda status=progress\n\n9 - 启动新的系统卸载原有硬盘，重启即可，最终效果如下  \n\n可能出现的问题A - initramfs 无法加载 ZFS 驱动\n症状：出现 Failed to load the ZFS Module. 提示\n原因：未正确对模块进行签名，UEFI 安全启动策略不允许载入\n\nB - initramfs 未找到 zpool\n症状：开机时卡在 Begin: Running /scripts/local-block … done 很久\n症状：出现 ZFS Boot failing in initramfs : Alert! ZFS=rpool/ROOT/proxmox does not exists 类似提示\n原因：initramfs 中没有 zfs 工具，或 zpool 无法被安全导入，请确认第 5 步的 zfs-initramfs 是否正确安装、第 7 步是否成功导出\n解决方案：尝试运行 zpool import -f bpool rpool &amp;&amp; exit，如果出现 command not found，说明 zfs-initramfs 未正确安装，请重新执行全部步骤\n\nC - ZFS 根目录无法卸载\n症状：完成第 7 步时出现 cannot unmount &#39;/mnt&#39;: pool or dataset is busy\n原因：第 3 步完成后，ZFS 所在的磁盘路径发生变化，或者有其他程序占用\n解决方法：如果更改了磁盘路径，需要先修改回来，然后检查是否有程序占用，如果有，请关闭，完成后重新尝试第 7 步，若仍然失败，请重启系统\n\n参考资料\nInstall Proxmox VE on Debian 12 Bookworm (pve.proxmox.com)\nPlease, I need Help. Reboot and Stuck on “initramfs” command line (Failed to load the ZFS Module) . (github.com)\nInstall Arch Linux on ZFS (wiki.archlinux.org)\nCopy entire file system hierarchy from one drive to another (superuser.com)\nHetzner独服安装Debian11并将ZFS作为根文件系统 (lala.im)\n\n","dateCreated":"2024-05-18T08:00:00+08:00","dateModified":"2024-05-18T08:00:00+08:00","datePublished":"2024-05-18T08:00:00+08:00","description":"Linux 更换根目录的 FS 为 ZFS 是可行的，写一篇教程记录下大致步骤和可能出现的问题  ","headline":"将 Debian 的根目录 FS 切换为 ZFS","image":["https://cos.mbrjun.cn/IMGS/2024/05/18/78cb556f-4786-4496-ad2d-9a1802aa81d6.webp"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.mbrjun.cn/archives/497/"},"publisher":{"@type":"Organization","name":"MBRjun","sameAs":["https://github.com/MBRjun","https://twitter.com/MBRjun","mailto:neko@mbr.moe"],"image":"https://cos.mbrjun.cn/PICS/LG4v3avatar144px.jpg","logo":{"@type":"ImageObject","url":"https://cos.mbrjun.cn/PICS/LG4v3avatar144px.jpg"}},"url":"https://www.mbrjun.cn/archives/497/","keywords":"Linux, ZFS","thumbnailUrl":"https://cos.mbrjun.cn/IMGS/2024/05/18/78cb556f-4786-4496-ad2d-9a1802aa81d6.webp"}</script><meta name="description" content="Linux 更换根目录的 FS 为 ZFS 是可行的，写一篇教程记录下大致步骤和可能出现的问题"><meta property="og:type" content="blog"><meta property="og:title" content="将 Debian 的根目录 FS 切换为 ZFS"><meta property="og:url" content="https://www.mbrjun.cn/archives/497/index.html"><meta property="og:site_name" content="MBRjun-Blog"><meta property="og:description" content="Linux 更换根目录的 FS 为 ZFS 是可行的，写一篇教程记录下大致步骤和可能出现的问题"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cos.mbrjun.cn/IMGS/2024/05/18/80753f54-2a33-4adf-b11b-c4ef865757b0.webp"><meta property="article:published_time" content="2024-05-18T00:00:00.000Z"><meta property="article:modified_time" content="2024-05-18T00:00:00.000Z"><meta property="article:author" content="MBRjun"><meta property="article:tag" content="Linux"><meta property="article:tag" content="ZFS"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cos.mbrjun.cn/IMGS/2024/05/18/80753f54-2a33-4adf-b11b-c4ef865757b0.webp"><meta name="twitter:creator" content="@MBRjun"><meta property="og:image" content="https://cos.mbrjun.cn/PICS/LG4v3avatar144px.jpg"><meta property="og:image" content="https://cos.mbrjun.cn/IMGS/2024/05/18/78cb556f-4786-4496-ad2d-9a1802aa81d6.webp"><meta class="swiftype" name="image" data-type="enum" content="https://cos.mbrjun.cn/IMGS/2024/05/18/78cb556f-4786-4496-ad2d-9a1802aa81d6.webp"><!--STYLES--><link rel="stylesheet" href="/assets/css/style.min.css?v=ef268bae0eb8f6e26cdd5bea3344cc9f8d659b6e"><!--STYLES END--><!--SCRIPTS--><script async="" defer="" src="/assets/js/script.min.js?v=ef268bae0eb8f6e26cdd5bea3344cc9f8d659b6e"></script><!--SCRIPTS END--><!--PRELOAD--><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="//github.githubassets.com"><link rel="dns-prefetch" href="//avatars.githubusercontent.com"><link rel="preconnect" href="https://cos.mbrjun.cn"><link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="/assets/fonts/GoogleSansDisplay-BR.woff2"><link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="/assets/fonts/GoogleSansDisplay-LR.woff2"><link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="/assets/fonts/fa-solid-900.woff2"><link rel="preload" as="font" crossorigin="anonymous" type="font/woff2" href="/assets/fonts/fa-brands-400.woff2"><!--PRELOAD END--><script>"use strict";var scripts=["/assets/js/webp-polyfill.min.js?v=2.0.1"];function parallelLoadScripts(e,t){"object"!=typeof e&&(e=[e]);for(var n=document.getElementsByTagName("head")[0]||document.documentElement,o=[],l=0,i=0;i<e.length;i++)o[i]=document.createElement("script"),o[i].setAttribute("type","text/javascript"),o[i].onload=o[i].onreadystatechange=function(){l++,this.onload=this.onreadystatechange=null,this.parentNode.removeChild(this),l===e.length&&"function"==typeof t&&t()},o[i].setAttribute("src",e[i]),n.appendChild(o[i])}"ActiveXObject"in window&&parallelLoadScripts(scripts,function(){console.log("[hexo-webp-polyfill] polyfilling document"),(new webpHero.WebpMachine).polyfillDocument()});</script></head><body><div id="blog"><!-- Define author's picture --><header id="header" data-behavior="2"><i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i><div class="header-title"><a class="header-title-link" href="/" aria-label="">MBRjun-Blog</a></div><a class="header-right-picture" href="/about" aria-label="打开链接: /about"><img class="header-picture" src="https://cos.mbrjun.cn/PICS/LG4v3avatar144px.jpg" alt="作者的图片"></a></header><!-- Define author's picture --><nav id="sidebar" data-behavior="2"><div class="sidebar-container"><div class="sidebar-profile"><a href="/#about" aria-label="阅读有关作者的更多信息"><img class="sidebar-profile-picture" src="https://cos.mbrjun.cn/PICS/LG4v3avatar144px.jpg" alt="作者的图片"></a><h4 class="sidebar-profile-name">MBRjun</h4><h5 class="sidebar-profile-bio"><p>我们生活在大地上，但我们的梦想超越天空</p></h5></div><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/" rel="noopener" title="首页"><i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i> <span class="sidebar-button-desc">首页</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-categories" rel="noopener" title="分类"><i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i> <span class="sidebar-button-desc">分类</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-tags" rel="noopener" title="标签"><i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i> <span class="sidebar-button-desc">标签</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-archives" rel="noopener" title="归档"><i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i> <span class="sidebar-button-desc">归档</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/links" rel="noopener" title="友情链接"><i class="sidebar-button-icon fa fa-link" aria-hidden="true"></i> <span class="sidebar-button-desc">友情链接</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="https://www.travellings.cn/go.html" target="_blank" rel="noopener" title="开往"><i class="sidebar-button-icon fa fa-paper-plane" aria-hidden="true"></i> <span class="sidebar-button-desc">开往</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="https://github.com/MBRjun" target="_blank" rel="noopener" title="GitHub"><i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i> <span class="sidebar-button-desc">GitHub</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="https://twitter.com/MBRjun" target="_blank" rel="noopener" title="Twitter"><i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i> <span class="sidebar-button-desc">Twitter</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="mailto:neko@mbr.moe" target="_blank" rel="noopener" title="邮箱"><i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i> <span class="sidebar-button-desc">邮箱</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/atom.xml" rel="noopener" title="RSS"><i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i> <span class="sidebar-button-desc">RSS</span></a></li></ul></div></nav><div id="main" data-behavior="2" class="hasCoverMetaIn"><article class="post"><div class="post-header main-content-wrap text-left"><h1 class="post-title">将 Debian 的根目录 FS 切换为 ZFS</h1><div class="post-meta"><time datetime="2024-05-18T08:00:00+08:00">2024 年 5 月 18 日 </time><span>发布在 </span><a class="category-link" href="/categories/%E6%95%99%E7%A8%8B/">教程</a></div></div><div class="post-content markdown"><div class="main-content-wrap"><p>Linux 更换根目录的 FS 为 ZFS 是可行的，写一篇教程记录下大致步骤和可能出现的问题</p><span id="more"></span><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ul><li>不比系统盘小的一块空硬盘</li></ul><h2 id="操作过程"><a href="#操作过程" class="headerlink" title="操作过程"></a>操作过程</h2><h3 id="1-ZFS-驱动和工具"><a href="#1-ZFS-驱动和工具" class="headerlink" title="1 - ZFS 驱动和工具"></a>1 - ZFS 驱动和工具</h3><p>Debian 目前默认的内核并没有集成 ZFS 驱动，必须更换内核或者手动安装内核模块才能正常使用 ZFS</p><p><strong>方法一</strong></p><p>这里可以直接安装 <code>proxmox-ve</code> 包，Proxmox VE 自带了 ZFS 的管理工具和驱动（驱动由 Proxmox VE 的定制内核提供）， 且 PVE 对 ZFS 的支持也非常全：</p><div class="alert info"><p>如果你安装了 qemu，此方法会将你的 qemu 替换为 PVE 修改后的版本</p></div><div class="alert info"><p>如果你使用 systemd-timesyncd 用于时间同步，此方法会将你的 systemd-timesyncd 替换为 chrony</p></div><div class="alert warning"><p>下面的安装命令仅适用于 Debian 12 Bookworm AMD64，其他 Debian 版本或其他架构无法使用</p></div><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">echo</span> <span class="hljs-string">"deb [arch=amd64] http://download.proxmox.com/debian/pve bookworm pve-no-subscription"</span> &gt; /etc/apt/sources.list.d/pve-install-repo.list<br>wget https://enterprise.proxmox.com/debian/proxmox-release-bookworm.gpg -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg <br>apt update<br>apt install proxmox-default-kernel proxmox-ve postfix open-iscsi chrony -y<br>apt remove linux-image-amd64 <span class="hljs-string">'linux-image-6.1*'</span> -y<br>update-grub<br>systemctl reboot<br></code></pre></td></tr></tbody></table></figure><p>如果只使用 Proxmox VE 的 ZFS 管理工具和驱动，不使用 Proxmox VE 虚拟机，可以考虑把 <code>proxmox-ve</code> 卸载掉：<code>apt remove proxmox-ve -y</code></p><p><strong>方法二</strong></p><p>使用原有内核，不安装 <code>proxmox-ve</code> 或其他内核，使用 dkms 手动安装 ZFS 驱动</p><div class="alert warning"><p>此方法可能无法在启用了 UEFI 安全启动的设备上正常工作，原因如下：</p><p>Linux 5.4 中添加了 <code>kernel_lockdown</code> 功能，在启用 UEFI 安全启动的设备上，<code>kernel_lockdown</code> 强制启用，此功能只能在内核编译时去掉</p><p><code>kernel_lockdown</code> 会阻止系统载入未签名的自定义模块，<code>zfs-dkms</code> 就是未签名的模块</p><p><strong>您必须为内核和 dkms 配置自定义签名才能在启用了 UEFI 安全启动的设备上使用此方法</strong>（流程非常复杂，可能还需要在 UEFI 固件设置里手动导入证书，能单独再写一篇文章了）</p></div><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">apt install linux-headers-amd64 zfsutils-linux zfs-dkms<br>modprobe zfs<br></code></pre></td></tr></tbody></table></figure><h3 id="2-复制磁盘数据"><a href="#2-复制磁盘数据" class="headerlink" title="2 - 复制磁盘数据"></a>2 - 复制磁盘数据</h3><p>假设原硬盘的分区结构如下：</p><table><tbody><tr><td colspan="2"><b>vda</b></td></tr><tr></tr><tr><td><b>1</b></td><td><b>2</b></td><td><b>3</b></td><td></td></tr><tr></tr><tr><td>BIOS Boot</td><td>Linux filesystem</td><td>Linux LVM</td><td></td></tr><tr></tr><tr><td></td><td><b>ext4 /boot</b></td><td><b>VG system</b></td><td></td></tr><tr></tr><tr><td></td><td></td><td><b>root</b></td><td><b>swap</b></td></tr><tr></tr><tr><td></td><td></td><td>btrfs /</td><td>swap</td></tr><tr></tr></tbody></table><p>先把系统盘（以 vda 为例）复制到另一块盘 vdb，然后清除掉 vdb 上的 boot 和 root 分区</p><div class="alert info"><p>如果你的系统盘上有 LVM，你需要在磁盘克隆后使用 <code>vgimportclone</code> 重新生成 LVM 的 UUID，命令已在下方给出</p></div><div class="alert info"><p>UEFI 用户需要两个分区用于启动，一个是 ESP（应挂载到 /boot/efi），另一个是 ZFS 启动分区（应挂载到 /boot），我只以传统引导演示，因为我不使用 UEFI 也没有 ESP（</p></div><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">vgrename system systemOld<br><span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/vda of=/dev/vdb bs=1M status=progress<br>vgimportclone /dev/vdb3 -n system <span class="hljs-comment"># regen LVM uuids</span><br>wipefs -a /dev/vdb2<br>wipefs -a /dev/system/root<br></code></pre></td></tr></tbody></table></figure><p>完成后磁盘分区结构大致是：</p><table><tbody><tr><td colspan="2"><b>vdb</b></td></tr><tr></tr><tr><td><b>1</b></td><td><b>2</b></td><td><b>3</b></td><td></td></tr><tr></tr><tr><td>BIOS Boot</td><td>Linux filesystem</td><td>Linux LVM</td><td></td></tr><tr></tr><tr><td></td><td></td><td><b>VG system</b></td><td></td></tr><tr></tr><tr><td></td><td></td><td><b>root</b></td><td><b>swap</b></td></tr><tr></tr><tr><td></td><td></td><td></td><td>swap</td></tr><tr></tr></tbody></table><h3 id="3-创建-ZFS"><a href="#3-创建-ZFS" class="headerlink" title="3 - 创建 ZFS"></a>3 - 创建 ZFS</h3><p>bpool，用于引导：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sh">zpool create \<br>    -f \<br>    -o cachefile= \<br>    -o ashift=12 -d \<br>    -o feature@async_destroy=enabled \<br>    -o feature@bookmarks=enabled \<br>    -o feature@embedded_data=enabled \<br>    -o feature@empty_bpobj=enabled \<br>    -o feature@enabled_txg=enabled \<br>    -o feature@extensible_dataset=enabled \<br>    -o feature@filesystem_limits=enabled \<br>    -o feature@hole_birth=enabled \<br>    -o feature@large_blocks=enabled \<br>    -o feature@livelist=enabled \<br>    -o feature@lz4_compress=enabled \<br>    -o feature@spacemap_histogram=enabled \<br>    -o feature@zpool_checkpoint=enabled \<br>    -O acltype=posixacl -O canmount=off -O compression=lz4 \<br>    -O devices=off -O normalization=formD -O relatime=on -O xattr=sa \<br>    -O mountpoint=/boot -R /mnt \<br>    bpool \<br>    /dev/vdb2<br></code></pre></td></tr></tbody></table></figure><p>rpool，存储 rootfs：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">zpool create \<br>    -f \<br>    -o ashift=12 \<br>    -O acltype=posixacl -O canmount=off -O compression=lz4 \<br>    -O normalization=formD -O relatime=on \<br>    -O xattr=sa -O mountpoint=/ -R /mnt \<br>    rpool \<br>    /dev/system/root<br></code></pre></td></tr></tbody></table></figure><p>创建数据集：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">zfs create -o canmount=noauto -o mountpoint=/ rpool/ROOT/proxmox<br>zfs mount rpool/ROOT/proxmox<br>zfs create -o mountpoint=/boot bpool/BOOT/proxmox<br></code></pre></td></tr></tbody></table></figure><p>上面的操作完成后磁盘分区结构大致是：</p><table><tbody><tr><td colspan="2"><b>vdb</b></td></tr><tr></tr><tr><td><b>1</b></td><td><b>2</b></td><td><b>3</b></td><td></td></tr><tr></tr><tr><td>BIOS Boot</td><td>Linux filesystem</td><td>Linux LVM</td><td></td></tr><tr></tr><tr><td></td><td><b>zpool bpool</b></td><td><b>VG system</b></td><td></td></tr><tr></tr><tr><td></td><td><b>BOOT</b></td><td><b>zpool rpool</b></td><td><b>swap</b></td></tr><tr></tr><tr><td></td><td>zfs /boot</td><td><b>ROOT</b></td><td>swap</td></tr><tr></tr><tr><td></td><td></td><td>zfs /</td><td></td></tr><tr></tr></tbody></table><h3 id="4-拷贝文件"><a href="#4-拷贝文件" class="headerlink" title="4 - 拷贝文件"></a>4 - 拷贝文件</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">apt install rsync -y<br>rsync -axHAWXS --numeric-ids --info=progress2 / /mnt<br>rsync -axHAWXS --numeric-ids --info=progress2 /boot /mnt<br></code></pre></td></tr></tbody></table></figure><h3 id="5-更新引导"><a href="#5-更新引导" class="headerlink" title="5 - 更新引导"></a>5 - 更新引导</h3><p>在 vdb 创建新的引导文件：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">mount --rbind /proc /mnt/proc<br>mount --rbind /sys /mnt/sys<br>mount --rbind /dev /mnt/dev<br><span class="hljs-built_in">chroot</span> /mnt<br>apt install zfs-initramfs -y<br>update-initramfs -c -k all<br>grub-install /dev/vdb<br>update-grub<br></code></pre></td></tr></tbody></table></figure><h3 id="6-更新-fstab"><a href="#6-更新-fstab" class="headerlink" title="6 - 更新 fstab"></a>6 - 更新 fstab</h3><p>ZFS 不依赖 fstab 挂载，挂载信息存储在文件系统中，自行清理 fstab 的无用条目</p><h3 id="7-导出-ZFS"><a href="#7-导出-ZFS" class="headerlink" title="7 - 导出 ZFS"></a>7 - 导出 ZFS</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">exit</span> <span class="hljs-comment"># quit chroot</span><br>mount | grep -v zfs | <span class="hljs-built_in">tac</span> | awk <span class="hljs-string">'/\/mnt/ {print $3}'</span> | \<br>    xargs -i{} umount -lf {}<br>zpool <span class="hljs-built_in">export</span> -a<br></code></pre></td></tr></tbody></table></figure><h3 id="8-将-ZFS-写回原系统盘"><a href="#8-将-ZFS-写回原系统盘" class="headerlink" title="8 - 将 ZFS 写回原系统盘"></a>8 - 将 ZFS 写回原系统盘</h3><p><strong>方法一</strong></p><p>如果有 LiveCD，直接进 LiveCD 执行：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/vdb of=/dev/vda status=progress<br></code></pre></td></tr></tbody></table></figure><p><strong>方法二</strong></p><p>如果没有 LiveCD，则将根目录系统挂载为只读，然后再复制：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">mount -o remount,ro / <span class="hljs-comment"># soft remount ro</span><br><span class="hljs-built_in">echo</span> u &gt; /proc/sysrq-trigger <span class="hljs-comment"># force remount ro, not work in btrfs</span><br><span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/vdb of=/dev/vda status=progress<br></code></pre></td></tr></tbody></table></figure><h3 id="9-启动新的系统"><a href="#9-启动新的系统" class="headerlink" title="9 - 启动新的系统"></a>9 - 启动新的系统</h3><p>卸载原有硬盘，重启即可，最终效果如下</p><p><img src="https://cos.mbrjun.cn/IMGS/2024/05/18/80753f54-2a33-4adf-b11b-c4ef865757b0.webp" alt="ZFS installed"></p><h2 id="可能出现的问题"><a href="#可能出现的问题" class="headerlink" title="可能出现的问题"></a>可能出现的问题</h2><h3 id="A-initramfs-无法加载-ZFS-驱动"><a href="#A-initramfs-无法加载-ZFS-驱动" class="headerlink" title="A - initramfs 无法加载 ZFS 驱动"></a>A - initramfs 无法加载 ZFS 驱动</h3><ul><li>症状：出现 <code>Failed to load the ZFS Module.</code> 提示</li><li>原因：未正确对模块进行签名，UEFI 安全启动策略不允许载入</li></ul><h3 id="B-initramfs-未找到-zpool"><a href="#B-initramfs-未找到-zpool" class="headerlink" title="B - initramfs 未找到 zpool"></a>B - initramfs 未找到 zpool</h3><ul><li>症状：开机时卡在 <code>Begin: Running /scripts/local-block … done</code> 很久</li><li>症状：出现 <code>ZFS Boot failing in initramfs : Alert! ZFS=rpool/ROOT/proxmox does not exists</code> 类似提示</li><li>原因：initramfs 中没有 zfs 工具，或 zpool 无法被安全导入，请确认第 5 步的 <code>zfs-initramfs</code> 是否正确安装、第 7 步是否成功导出</li><li>解决方案：尝试运行 <code>zpool import -f bpool rpool &amp;&amp; exit</code>，如果出现 <code>command not found</code>，说明 <code>zfs-initramfs</code> 未正确安装，请重新执行全部步骤</li></ul><h3 id="C-ZFS-根目录无法卸载"><a href="#C-ZFS-根目录无法卸载" class="headerlink" title="C - ZFS 根目录无法卸载"></a>C - ZFS 根目录无法卸载</h3><ul><li>症状：完成第 7 步时出现 <code>cannot unmount '/mnt': pool or dataset is busy</code></li><li>原因：第 3 步完成后，ZFS 所在的磁盘路径发生变化，或者有其他程序占用</li><li>解决方法：如果更改了磁盘路径，需要先修改回来，然后检查是否有程序占用，如果有，请关闭，完成后重新尝试第 7 步，若仍然失败，请重启系统</li></ul><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="noopener" href="https://pve.proxmox.com/wiki/Install_Proxmox_VE_on_Debian_12_Bookworm">Install Proxmox VE on Debian 12 Bookworm (pve.proxmox.com)</a></li><li><a target="_blank" rel="noopener" href="https://github.com/linux-surface/linux-surface/issues/942">Please, I need Help. Reboot and Stuck on “initramfs” command line (Failed to load the ZFS Module) . (github.com)</a></li><li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/Install_Arch_Linux_on_ZFS#Installation">Install Arch Linux on ZFS (wiki.archlinux.org)</a></li><li><a target="_blank" rel="noopener" href="https://superuser.com/questions/307541/copy-entire-file-system-hierarchy-from-one-drive-to-another">Copy entire file system hierarchy from one drive to another (superuser.com)</a></li><li><a target="_blank" rel="noopener" href="https://lala.im/8318.html">Hetzner独服安装Debian11并将ZFS作为根文件系统 (lala.im)</a></li></ul></div></div><div id="post-footer" class="post-footer main-content-wrap"><div class="post-footer-tags"><span class="text-color-light text-small">标签</span><br><a class="tag tag--primary tag--small t-none-link" href="/tags/Linux/" rel="tag">Linux</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/ZFS/" rel="tag">ZFS</a></div><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/archives/498/" data-tooltip="将 Exos 硬盘格式化为 4Kn" aria-label="上一篇: 将 Exos 硬盘格式化为 4Kn"><i class="fa fa-angle-left" aria-hidden="true"></i> <span class="hide-xs hide-sm text-small icon-ml">上一篇</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/archives/496/" data-tooltip="针对 LUKS 自动解锁的冷启动攻击" aria-label="下一篇: 针对 LUKS 自动解锁的冷启动攻击"><span class="hide-xs hide-sm text-small icon-mr">下一篇</span> <i class="fa fa-angle-right" aria-hidden="true"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Diesen Beitrag teilen"><i class="fa fa-share-alt" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://www.mbrjun.cn/archives/497/" title="分享到 Twitter" aria-label="分享到 Twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://www.mbrjun.cn/archives/497/" title="分享到 Weibo" aria-label="分享到 Weibo"><i class="fab fa-weibo" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://www.mbrjun.cn/archives/497/&amp;title=将 Debian 的根目录 FS 切换为 ZFS" title="分享到 QQ" aria-label="分享到 QQ"><i class="fab fa-qq" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.mbrjun.cn/archives/497/" title="分享到 Qzone" aria-label="分享到 Qzone"><i class="fa fa-star" aria-hidden="true"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben"><i class="fa fa-list" aria-hidden="true"></i></a></li></ul></div><script src="https://giscus.mbrjun.cn/client.js" data-repo="MBRjun/MBRjun-Blog" data-repo-id="R_kgDOIbI33Q" data-category="Blog" data-category-id="DIC_kwDOIbI33c4CTUTq" data-mapping="title" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light_tritanopia" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async=""></script></div></article><footer id="footer" class="main-content-wrap"><span class="copyrights"><a target="_blank" rel="noopener" href="https://github.com/MBRjun/MBRjun-Blog">GitHub 源代码</a> - <a target="_blank" rel="noopener" href="https://github.com/MBRjun/MBRjun-Blog/blob/main/LICENSE">LICENSE(CC BY-SA 3)</a><br></span><span class="text-small"><a target="_blank" href="https://beian.miit.gov.cn" rel="nofollow noopener">闽ICP备2024060656号-1</a> - <a target="_blank" href="http://www.beian.gov.cn" rel="nofollow noopener">津公网安备12010102001086号</a><br></span><span class="copyrights">Copyrights © 2024 MBRjun. All Rights Reserved.</span></footer><script async="" defer="" data-website-id="d1e9e8b4-ed73-416a-b8e7-ae518e698da6" src="https://delightful.mbrjun.cn/delightful.js?v=2.2.0-1"></script></div><div id="bottom-bar" class="post-bottom-bar" data-behavior="2"><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/archives/498/" data-tooltip="将 Exos 硬盘格式化为 4Kn" aria-label="上一篇: 将 Exos 硬盘格式化为 4Kn"><i class="fa fa-angle-left" aria-hidden="true"></i> <span class="hide-xs hide-sm text-small icon-ml">上一篇</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/archives/496/" data-tooltip="针对 LUKS 自动解锁的冷启动攻击" aria-label="下一篇: 针对 LUKS 自动解锁的冷启动攻击"><span class="hide-xs hide-sm text-small icon-mr">下一篇</span> <i class="fa fa-angle-right" aria-hidden="true"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Diesen Beitrag teilen"><i class="fa fa-share-alt" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://www.mbrjun.cn/archives/497/" title="分享到 Twitter" aria-label="分享到 Twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://www.mbrjun.cn/archives/497/" title="分享到 Weibo" aria-label="分享到 Weibo"><i class="fab fa-weibo" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://www.mbrjun.cn/archives/497/&amp;title=将 Debian 的根目录 FS 切换为 ZFS" title="分享到 QQ" aria-label="分享到 QQ"><i class="fab fa-qq" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.mbrjun.cn/archives/497/" title="分享到 Qzone" aria-label="分享到 Qzone"><i class="fa fa-star" aria-hidden="true"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben"><i class="fa fa-list" aria-hidden="true"></i></a></li></ul></div></div><div id="share-options-bar" class="share-options-bar" data-behavior="2"><i id="btn-close-shareoptions" class="fa fa-times"></i><ul class="share-options"><li class="share-option"><a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https://www.mbrjun.cn/archives/497/" aria-label="分享到 Twitter"><i class="fab fa-twitter" aria-hidden="true"></i><span>分享到 Twitter</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://www.mbrjun.cn/archives/497/" aria-label="分享到 Weibo"><i class="fab fa-weibo" aria-hidden="true"></i><span>分享到 Weibo</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://www.mbrjun.cn/archives/497/&amp;title=将 Debian 的根目录 FS 切换为 ZFS" aria-label="分享到 QQ"><i class="fab fa-qq" aria-hidden="true"></i><span>分享到 QQ</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.mbrjun.cn/archives/497/" aria-label="分享到 Qzone"><i class="fa fa-star" aria-hidden="true"></i><span>分享到 Qzone</span></a></li></ul></div></div><div id="about"><div id="about-card"><div id="about-btn-close"><i class="fa fa-times"></i></div><img id="about-card-picture" src="https://cos.mbrjun.cn/PICS/LG4v3avatar144px.jpg" alt="作者的图片"><h4 id="about-card-name">MBRjun</h4><div id="about-card-bio"><p>我们生活在大地上，但我们的梦想超越天空</p></div><div id="about-card-job"><i class="fa fa-briefcase"></i><br><p>学生</p></div><div id="about-card-location"><i class="fa fa-map-marker-alt"></i><br>地球</div></div></div><div id="cover" style="background-image:url('https://cos.mbrjun.cn/IMGS/2023/03/23/4419f34e-9353-4b44-a6dd-ebb1db958fc5.webp');"></div><!-- 
█▀▄▀█ █▄▄ █▀█ ░░█ █░█ █▄░█ ▄▄ █▄▄ █░░ █▀█ █▀▀
█░▀░█ █▄█ █▀▄ █▄█ █▄█ █░▀█ ░░ █▄█ █▄▄ █▄█ █▄█
MBRjun-Blog 2024 - with Hexo 7 - tk-mbr NYA-
Commit ef268bae0eb8f6e26cdd5bea3344cc9f8d659b6e
Build on: runner@Azure-GitHub-Actions (running kernel: 6.5.0-1024-azure)
Date: 2024-08-02 Preset: CI --></body></html>